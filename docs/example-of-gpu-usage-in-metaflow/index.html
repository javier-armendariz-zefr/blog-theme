<!DOCTYPE html>
<html lang="en" class="no-js">
    <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    
    

    
    

    
    

    
    

    <title>Example of GPU usage in Metaflow | Zefr Engineering Blog</title>
    <meta name="description" content="GPU usage for deep learning is not trivial in Metaflow due to the fact that one needs to install CUDA in a correct way and expose the GPU hardwares to the co...">
    
        <meta name="keywords" content="python">
    

    <!-- Social: Twitter -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Example of GPU usage in Metaflow | Zefr Engineering Blog">
    <meta name="twitter:description" content="GPU usage for deep learning is not trivial in Metaflow due to the fact that one needs to install CUDA in a correct way and expose the GPU hardwares to the co...">
    <meta property="twitter:image:src" content="/blog-theme/assets/img/posts/example-of-gpu-usage-in-metaflow/metaflow.jpg">
    
        <meta name="twitter:site" content="@zefrinc">
    

    <!-- Social: Facebook / Open Graph -->
    <meta property="og:url" content="/blog-theme/example-of-gpu-usage-in-metaflow/">
    <meta property="og:title" content="Example of GPU usage in Metaflow | Zefr Engineering Blog">
    <meta property="og:image" content="/blog-theme/assets/img/posts/example-of-gpu-usage-in-metaflow/metaflow.jpg">
    <meta property="og:description" content="GPU usage for deep learning is not trivial in Metaflow due to the fact that one needs to install CUDA in a correct way and expose the GPU hardwares to the co...">
    <meta property="og:site_name" content="Zefr | Engineering Blog">

    <!-- Favicon -->
    <link rel="shortcut icon" href="/blog-theme/favicon.ico" type="image/x-icon" />
    
    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" href="/blog-theme/blog-theme/assets/img/icons/apple-touch-icon.png" />
    <link rel="apple-touch-icon" sizes="57x57" href="/blog-theme/assets/img/icons/apple-touch-icon-57x57.png" />
    <link rel="apple-touch-icon" sizes="72x72" href="/blog-theme/assets/img/icons/apple-touch-icon-72x72.png" />
    <link rel="apple-touch-icon" sizes="114x114" href="/blog-theme/assets/img/icons/apple-touch-icon-114x114.png" />
    <link rel="apple-touch-icon" sizes="144x144" href="/blog-theme/assets/img/icons/apple-touch-icon-144x144.png" />
    <link rel="apple-touch-icon" sizes="60x60" href="/blog-theme/assets/img/icons/apple-touch-icon-60x60.png" />
    <link rel="apple-touch-icon" sizes="120x120" href="/blog-theme/assets/img/icons/apple-touch-icon-120x120.png" />
    <link rel="apple-touch-icon" sizes="76x76" href="/blog-theme/assets/img/icons/apple-touch-icon-76x76.png" />
    <link rel="apple-touch-icon" sizes="152x152" href="/blog-theme/assets/img/icons/apple-touch-icon-152x152.png" />

    <!-- Windows 8 Tile Icons -->
    <meta name="application-name" content="Zefr Engineering Blog">
    <meta name="msapplication-TileColor" content="#141414">
    <meta name="msapplication-square70x70logo" content="smalltile.png" />
    <meta name="msapplication-square150x150logo" content="mediumtile.png" />
    <meta name="msapplication-wide310x150logo" content="widetile.png" />
    <meta name="msapplication-square310x310logo" content="largetile.png" />
    
    <!-- Android Lolipop Theme Color -->
    <meta name="theme-color" content="#141414">

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css?family=Titillium+Web:300,400,700" rel="stylesheet">

    <link rel="stylesheet" href="/blog-theme/assets/css/styles.css">
    <link rel="canonical" href="/blog-theme/example-of-gpu-usage-in-metaflow/">
    <link rel="alternate" type="application/rss+xml" title="Zefr | Engineering Blog" href="/blog-theme/feed.xml" />

    <!-- Include extra styles -->
    

    <!-- JavaScript enabled/disabled -->
    <script>
        document.querySelector('html').classList.remove('no-js');
    </script>
</head>

    <body class="has-push-menu">
        





        <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" display="none" version="1.1"><defs><symbol id="icon-menu" viewBox="0 0 1024 1024"><path class="path1" d="M128 213.333h768q17.667 0 30.167 12.5t12.5 30.167-12.5 30.167-30.167 12.5h-768q-17.667 0-30.167-12.5t-12.5-30.167 12.5-30.167 30.167-12.5zM128 725.333h768q17.667 0 30.167 12.5t12.5 30.167-12.5 30.167-30.167 12.5h-768q-17.667 0-30.167-12.5t-12.5-30.167 12.5-30.167 30.167-12.5zM128 469.333h768q17.667 0 30.167 12.5t12.5 30.167-12.5 30.167-30.167 12.5h-768q-17.667 0-30.167-12.5t-12.5-30.167 12.5-30.167 30.167-12.5z"/></symbol><symbol id="icon-search" viewBox="0 0 951 1024"><path class="path1" d="M658.286 475.429q0-105.714-75.143-180.857t-180.857-75.143-180.857 75.143-75.143 180.857 75.143 180.857 180.857 75.143 180.857-75.143 75.143-180.857zM950.857 950.857q0 29.714-21.714 51.429t-51.429 21.714q-30.857 0-51.429-21.714l-196-195.429q-102.286 70.857-228 70.857-81.714 0-156.286-31.714t-128.571-85.714-85.714-128.571-31.714-156.286 31.714-156.286 85.714-128.571 128.571-85.714 156.286-31.714 156.286 31.714 128.571 85.714 85.714 128.571 31.714 156.286q0 125.714-70.857 228l196 196q21.143 21.143 21.143 51.429z"/></symbol><symbol id="icon-close" viewBox="0 0 1000 1000"><path d="M969.8,870.3c27,27.7,27,71.8,0,99.1C955.7,983,937.9,990,920,990c-17.9,0-35.7-7-49.7-20.7L500,599L129.6,969.4C115.6,983,97.8,990,79.9,990s-35.7-7-49.7-20.7c-27-27.3-27-71.4,0-99.1L400.9,500L30.3,129.3c-27-27.3-27-71.4,0-99.1c27.3-27,71.8-27,99.4,0L500,400.9L870.4,30.2c27.7-27,71.8-27,99.4,0c27,27.7,27,71.8,0,99.1L599.1,500L969.8,870.3z"/></symbol><symbol id="icon-twitter" viewBox="0 0 951 1024"><path class="path1" d="M925.714 233.143q-38.286 56-92.571 95.429 0.571 8 0.571 24 0 74.286-21.714 148.286t-66 142-105.429 120.286-147.429 83.429-184.571 31.143q-154.857 0-283.429-82.857 20 2.286 44.571 2.286 128.571 0 229.143-78.857-60-1.143-107.429-36.857t-65.143-91.143q18.857 2.857 34.857 2.857 24.571 0 48.571-6.286-64-13.143-106-63.714t-42-117.429v-2.286q38.857 21.714 83.429 23.429-37.714-25.143-60-65.714t-22.286-88q0-50.286 25.143-93.143 69.143 85.143 168.286 136.286t212.286 56.857q-4.571-21.714-4.571-42.286 0-76.571 54-130.571t130.571-54q80 0 134.857 58.286 62.286-12 117.143-44.571-21.143 65.714-81.143 101.714 53.143-5.714 106.286-28.571z"/></symbol><symbol id="icon-facebook" viewBox="0 0 585 1024"><path class="path1" d="M548 6.857v150.857h-89.714q-49.143 0-66.286 20.571t-17.143 61.714v108h167.429l-22.286 169.143h-145.143v433.714h-174.857v-433.714h-145.714v-169.143h145.714v-124.571q0-106.286 59.429-164.857t158.286-58.571q84 0 130.286 6.857z"/></symbol><symbol id="icon-clock" viewBox="0 0 1000 1000"><path d="M500,10C229.8,10,10,229.8,10,500c0,270.2,219.8,490,490,490c270.2,0,490-219.8,490-490C990,229.8,770.2,10,500,10z M500,910.2c-226.2,0-410.2-184-410.2-410.2c0-226.2,184-410.2,410.2-410.2c226.2,0,410.2,184,410.2,410.2C910.2,726.1,726.2,910.2,500,910.2z M753.1,374c8.2,11.9,5.2,28.1-6.6,36.3L509.9,573.7c-4.4,3.1-9.6,4.6-14.8,4.6c-4.1,0-8.3-1-12.1-3c-8.6-4.5-14-13.4-14-23.1V202.5c0-14.4,11.7-26.1,26.1-26.1c14.4,0,26.1,11.7,26.1,26.1v300l195.6-135.1C728.7,359.2,744.9,362.1,753.1,374z"/></symbol><symbol id="icon-calendar" viewBox="0 0 1000 1000"><path d="M920,500v420H80V500H920 M990,430H10v490c0,38.7,31.3,70,70,70h840c38.7,0,70-31.3,70-70V430L990,430z"/><path d="M850,80v105c0,57.9-47.2,105-105,105c-58,0-105-47.1-105-105V80H360v105c0,57.9-47.2,105-105,105c-58,0-105-47.1-105-105V80C72.8,80,10,142.7,10,220v140h980V220C990,142.7,927.2,80,850,80z"/><path d="M255,10c-19.3,0-35,15.8-35,35v140c0,19.2,15.7,35,35,35c19.3,0,35-15.8,35-35V45C290,25.8,274.3,10,255,10z"/><path d="M745,10c-19.3,0-35,15.8-35,35v140c0,19.2,15.7,35,35,35c19.3,0,35-15.8,35-35V45C780,25.8,764.3,10,745,10z"/></symbol><symbol id="icon-github" viewBox="0 0 12 14"><path d="M6 1q1.633 0 3.012 0.805t2.184 2.184 0.805 3.012q0 1.961-1.145 3.527t-2.957 2.168q-0.211 0.039-0.312-0.055t-0.102-0.234q0-0.023 0.004-0.598t0.004-1.051q0-0.758-0.406-1.109 0.445-0.047 0.801-0.141t0.734-0.305 0.633-0.52 0.414-0.82 0.16-1.176q0-0.93-0.617-1.609 0.289-0.711-0.062-1.594-0.219-0.070-0.633 0.086t-0.719 0.344l-0.297 0.187q-0.727-0.203-1.5-0.203t-1.5 0.203q-0.125-0.086-0.332-0.211t-0.652-0.301-0.664-0.105q-0.352 0.883-0.062 1.594-0.617 0.68-0.617 1.609 0 0.664 0.16 1.172t0.41 0.82 0.629 0.523 0.734 0.305 0.801 0.141q-0.305 0.281-0.383 0.805-0.164 0.078-0.352 0.117t-0.445 0.039-0.512-0.168-0.434-0.488q-0.148-0.25-0.379-0.406t-0.387-0.187l-0.156-0.023q-0.164 0-0.227 0.035t-0.039 0.090 0.070 0.109 0.102 0.094l0.055 0.039q0.172 0.078 0.34 0.297t0.246 0.398l0.078 0.18q0.102 0.297 0.344 0.48t0.523 0.234 0.543 0.055 0.434-0.027l0.18-0.031q0 0.297 0.004 0.691t0.004 0.426q0 0.141-0.102 0.234t-0.312 0.055q-1.812-0.602-2.957-2.168t-1.145-3.527q0-1.633 0.805-3.012t2.184-2.184 3.012-0.805zM2.273 9.617q0.023-0.055-0.055-0.094-0.078-0.023-0.102 0.016-0.023 0.055 0.055 0.094 0.070 0.047 0.102-0.016zM2.516 9.883q0.055-0.039-0.016-0.125-0.078-0.070-0.125-0.023-0.055 0.039 0.016 0.125 0.078 0.078 0.125 0.023zM2.75 10.234q0.070-0.055 0-0.148-0.062-0.102-0.133-0.047-0.070 0.039 0 0.141t0.133 0.055zM3.078 10.562q0.062-0.062-0.031-0.148-0.094-0.094-0.156-0.023-0.070 0.062 0.031 0.148 0.094 0.094 0.156 0.023zM3.523 10.758q0.023-0.086-0.102-0.125-0.117-0.031-0.148 0.055t0.102 0.117q0.117 0.047 0.148-0.047zM4.016 10.797q0-0.102-0.133-0.086-0.125 0-0.125 0.086 0 0.102 0.133 0.086 0.125 0 0.125-0.086zM4.469 10.719q-0.016-0.086-0.141-0.070-0.125 0.023-0.109 0.117t0.141 0.062 0.109-0.109z"></path></symbol><symbol id="icon-medium" viewBox="0 0 1000 1000"><path d="M336.5,240.2v641.5c0,9.1-2.3,16.9-6.8,23.2s-11.2,9.6-20,9.6c-6.2,0-12.2-1.5-18-4.4L37.3,782.7c-7.7-3.6-14.1-9.8-19.4-18.3S10,747.4,10,739V115.5c0-7.3,1.8-13.5,5.5-18.6c3.6-5.1,8.9-7.7,15.9-7.7c5.1,0,13.1,2.7,24.1,8.2l279.5,140C335.9,238.6,336.5,239.5,336.5,240.2L336.5,240.2z M371.5,295.5l292,473.6l-292-145.5V295.5z M990,305.3v576.4c0,9.1-2.6,16.5-7.7,22.1c-5.1,5.7-12,8.5-20.8,8.5s-17.3-2.4-25.7-7.1L694.7,784.9L990,305.3z M988.4,239.7c0,1.1-46.8,77.6-140.3,229.4C754.6,621,699.8,709.8,683.8,735.7L470.5,389l177.2-288.2c6.2-10.2,15.7-15.3,28.4-15.3c5.1,0,9.8,1.1,14.2,3.3l295.9,147.7C987.6,237.1,988.4,238.2,988.4,239.7L988.4,239.7z"/></symbol><symbol id="icon-instagram" viewBox="0 0 489.84 489.84"><path d="M249.62,50.46c65.4,0,73.14.25,99,1.43C372.47,53,385.44,57,394.07,60.32a75.88,75.88,0,0,1,28.16,18.32,75.88,75.88,0,0,1,18.32,28.16c3.35,8.63,7.34,21.6,8.43,45.48,1.18,25.83,1.43,33.57,1.43,99s-0.25,73.14-1.43,99c-1.09,23.88-5.08,36.85-8.43,45.48a81.11,81.11,0,0,1-46.48,46.48c-8.63,3.35-21.6,7.34-45.48,8.43-25.82,1.18-33.57,1.43-99,1.43s-73.15-.25-99-1.43c-23.88-1.09-36.85-5.08-45.48-8.43A75.88,75.88,0,0,1,77,423.86,75.88,75.88,0,0,1,58.69,395.7c-3.35-8.63-7.34-21.6-8.43-45.48-1.18-25.83-1.43-33.57-1.43-99s0.25-73.14,1.43-99c1.09-23.88,5.08-36.85,8.43-45.48A75.88,75.88,0,0,1,77,78.64a75.88,75.88,0,0,1,28.16-18.32c8.63-3.35,21.6-7.34,45.48-8.43,25.83-1.18,33.57-1.43,99-1.43m0-44.13c-66.52,0-74.86.28-101,1.47s-43.87,5.33-59.45,11.38A120.06,120.06,0,0,0,45.81,47.44,120.06,120.06,0,0,0,17.56,90.82C11.5,106.4,7.36,124.2,6.17,150.27s-1.47,34.46-1.47,101,0.28,74.86,1.47,101,5.33,43.87,11.38,59.45a120.06,120.06,0,0,0,28.25,43.38,120.06,120.06,0,0,0,43.38,28.25c15.58,6.05,33.38,10.19,59.45,11.38s34.46,1.47,101,1.47,74.86-.28,101-1.47,43.87-5.33,59.45-11.38a125.24,125.24,0,0,0,71.63-71.63c6.05-15.58,10.19-33.38,11.38-59.45s1.47-34.46,1.47-101-0.28-74.86-1.47-101-5.33-43.87-11.38-59.45a120.06,120.06,0,0,0-28.25-43.38,120.06,120.06,0,0,0-43.38-28.25C394.47,13.13,376.67,9,350.6,7.8s-34.46-1.47-101-1.47h0Z" transform="translate(-4.7 -6.33)" /><path d="M249.62,125.48A125.77,125.77,0,1,0,375.39,251.25,125.77,125.77,0,0,0,249.62,125.48Zm0,207.41a81.64,81.64,0,1,1,81.64-81.64A81.64,81.64,0,0,1,249.62,332.89Z" transform="translate(-4.7 -6.33)"/><circle cx="375.66" cy="114.18" r="29.39" /></symbol><symbol id="icon-linkedin" viewBox="0 0 12 14"><path d="M2.727 4.883v7.742h-2.578v-7.742h2.578zM2.891 2.492q0.008 0.57-0.395 0.953t-1.059 0.383h-0.016q-0.641 0-1.031-0.383t-0.391-0.953q0-0.578 0.402-0.957t1.051-0.379 1.039 0.379 0.398 0.957zM12 8.187v4.437h-2.57v-4.141q0-0.82-0.316-1.285t-0.988-0.465q-0.492 0-0.824 0.27t-0.496 0.668q-0.086 0.234-0.086 0.633v4.32h-2.57q0.016-3.117 0.016-5.055t-0.008-2.313l-0.008-0.375h2.57v1.125h-0.016q0.156-0.25 0.32-0.438t0.441-0.406 0.68-0.34 0.895-0.121q1.336 0 2.148 0.887t0.813 2.598z"></path></symbol><symbol id="icon-heart" viewBox="0 0 34 30"><path d="M17,29.7 L16.4,29.2 C3.5,18.7 0,15 0,9 C0,4 4,0 9,0 C13.1,0 15.4,2.3 17,4.1 C18.6,2.3 20.9,0 25,0 C30,0 34,4 34,9 C34,15 30.5,18.7 17.6,29.2 L17,29.7 Z M9,2 C5.1,2 2,5.1 2,9 C2,14.1 5.2,17.5 17,27.1 C28.8,17.5 32,14.1 32,9 C32,5.1 28.9,2 25,2 C21.5,2 19.6,4.1 18.1,5.8 L17,7.1 L15.9,5.8 C14.4,4.1 12.5,2 9,2 Z" id="Shape"></path></symbol><symbol id="icon-arrow-right" viewBox="0 0 25.452 25.452"><path d="M4.471,24.929v-2.004l12.409-9.788c0.122-0.101,0.195-0.251,0.195-0.411c0-0.156-0.073-0.31-0.195-0.409L4.471,2.526V0.522c0-0.2,0.115-0.384,0.293-0.469c0.18-0.087,0.396-0.066,0.552,0.061l15.47,12.202c0.123,0.1,0.195,0.253,0.195,0.409c0,0.16-0.072,0.311-0.195,0.411L5.316,25.34c-0.155,0.125-0.372,0.147-0.552,0.061C4.586,25.315,4.471,25.13,4.471,24.929z"/></symbol><symbol id="icon-star" viewBox="0 0 48 48"><path fill="currentColor" d="M44,24c0,11.045-8.955,20-20,20S4,35.045,4,24S12.955,4,24,4S44,12.955,44,24z"/><path fill="#ffffff" d="M24,11l3.898,7.898l8.703,1.301l-6.301,6.102l1.5,8.699L24,30.898L16.199,35l1.5-8.699l-6.301-6.102  l8.703-1.301L24,11z"/></symbol><symbol id="icon-read" viewBox="0 0 32 32"><path fill="currentColor" d="M29,4H3C1.343,4,0,5.343,0,7v18c0,1.657,1.343,3,3,3h10c0,0.552,0.448,1,1,1h4c0.552,0,1-0.448,1-1h10  c1.657,0,3-1.343,3-3V7C32,5.343,30.657,4,29,4z M29,5v20H18.708c-0.618,0-1.236,0.146-1.789,0.422l-0.419,0.21V5H29z M15.5,5  v20.632l-0.419-0.21C14.528,25.146,13.91,25,13.292,25H3V5H15.5z M31,25c0,1.103-0.897,2-2,2H18v1h-4v-1H3c-1.103,0-2-0.897-2-2V7  c0-0.737,0.405-1.375,1-1.722V25c0,0.552,0.448,1,1,1h10.292c0.466,0,0.925,0.108,1.342,0.317l0.919,0.46  c0.141,0.07,0.294,0.106,0.447,0.106c0.153,0,0.306-0.035,0.447-0.106l0.919-0.46C17.783,26.108,18.242,26,18.708,26H29  c0.552,0,1-0.448,1-1V5.278C30.595,5.625,31,6.263,31,7V25z M6,12.5C6,12.224,6.224,12,6.5,12h5c0.276,0,0.5,0.224,0.5,0.5  S11.776,13,11.5,13h-5C6.224,13,6,12.776,6,12.5z M6,14.5C6,14.224,6.224,14,6.5,14h5c0.276,0,0.5,0.224,0.5,0.5S11.776,15,11.5,15  h-5C6.224,15,6,14.776,6,14.5z M6,16.5C6,16.224,6.224,16,6.5,16h5c0.276,0,0.5,0.224,0.5,0.5S11.776,17,11.5,17h-5  C6.224,17,6,16.776,6,16.5z M20,12.5c0-0.276,0.224-0.5,0.5-0.5h5c0.276,0,0.5,0.224,0.5,0.5S25.776,13,25.5,13h-5  C20.224,13,20,12.776,20,12.5z M20,14.5c0-0.276,0.224-0.5,0.5-0.5h5c0.276,0,0.5,0.224,0.5,0.5S25.776,15,25.5,15h-5  C20.224,15,20,14.776,20,14.5z M20,16.5c0-0.276,0.224-0.5,0.5-0.5h5c0.276,0,0.5,0.224,0.5,0.5S25.776,17,25.5,17h-5  C20.224,17,20,16.776,20,16.5z"></path></symbol></defs></svg>

        <header class="bar-header">
    <!-- <a id="menu" role="button">
        <svg id="open" class="icon-menu"><use xlink:href="#icon-menu"></use></svg>
    </a> -->
    <h1 class="logo">
        <a href="/blog-theme/">
            
                <svg xmlns="http://www.w3.org/2000/svg" width="73.14" height="48" viewBox="0 0 73.14 48">
  <defs>
    <style>
      .cls-1 {
        fill: #fff;
      }
    </style>
  </defs>
  <title>logo-white</title>
  <g id="Layer_2" data-name="Layer 2">
    <g id="Layer_1-2" data-name="Layer 1">
      <path class="cls-1"
        d="M36.0485,30.9972c.777-1.6857.733-1.92-.4242-2.0981.5561-.6382.5529-1.12.169-1.5274a.763.763,0,0,1-.1209-.5711c.1073-.8275-.0375-.9861-.7907-.8374-.3954.0772-.5967.2165-.5943.5793a1.2572,1.2572,0,0,0,.0134.17,3.02,3.02,0,0,1-.01,1.343,19.8645,19.8645,0,0,1-1.162,2.9528A7.0712,7.0712,0,0,1,29.9949,34.33c-1.4437.714-3.1318.1675-3.1992-1.1776-.0995-1.99-.0575-4.0324-.0322-6.0649a1.1482,1.1482,0,0,1,.4962-.6788,6.2075,6.2075,0,0,1,1.4313-.4564,1.6079,1.6079,0,0,1,.1952-.0287.6383.6383,0,0,1,.7821.6647c.0265.4869-.0123,1,.037,1.4759a3.4476,3.4476,0,0,0,.2638.79c.3-.2762.7811-.5558.8641-.8335a10.6391,10.6391,0,0,0,.4456-2.4162c.0033-.0586.006-.1147.009-.17a1.6377,1.6377,0,0,1,.39-1.1231c.3534-.4184.4139-.8865.0422-1.0334-.604-.2387-.6324-.8145-.6122-1.4687.003-.0966.0035-.192.0008-.2851a1.5561,1.5561,0,0,0-.5445-1.3177,1.18,1.18,0,0,0-.2218-.1212,2.2288,2.2288,0,0,0-.6772-.0433,3.5138,3.5138,0,0,0-.2391.8217,15.3236,15.3236,0,0,1,.046,1.8052,2.0067,2.0067,0,0,1-.6334,1.1412,4.0058,4.0058,0,0,1-1.5888.6319.6179.6179,0,0,1-.6074-.4776c-.05-1.9843-.0515-3.9862-.0206-5.9957a2.1882,2.1882,0,0,1,1.1672-1.7654c1.65-1.0462,3.6689-1.0528,4.5879.08a4.9814,4.9814,0,0,1,1.0578,3.0553q.0091.2606-.0011.5343c-.0092.2463.1694.4318.2612.6454a3.3539,3.3539,0,0,0,.7789-.622,3.006,3.006,0,0,0,.4893-3.022.9939.9939,0,0,1,.0052-.6644,1.9455,1.9455,0,0,0-.0417-1.7412.5162.5162,0,0,1-.0384-.4211c.4936-1.2768.2284-2.5151-.6959-2.9124-.1954-.0843-.51.0242-.82.0467.0909,1.0809-.139,1.38-1.1153,1.5885-.3009.0638-.5982.0995-.8979.1506A10.2731,10.2731,0,0,0,26.22,15.02a1.7059,1.7059,0,0,0-.4847-.2686,2.2623,2.2623,0,0,0-2.3687.8048.8958.8958,0,0,1-.9189.3616c-1.6907-.2742-2.95.4857-3.7221,2.2855-.2044.4763-.0484.6829.4312.5541a11.3572,11.3572,0,0,1,1.0987-.3165c.961-.1545,1.2594.1042,1.2611,1.0627.0035,1.85-.0267,3.71.0212,5.5492a2.3173,2.3173,0,0,1-.6768,1.6894c-.2655.2955-.5362.5834-.89.9632.3523.0227.5741.0491.8013.0456.6344-.01.9233.2195.9064.95-.0269,1.1712-.0318,2.3375-.03,3.5031s.01,2.3284.01,3.4941c0,.8415-.412,1.2321-1.2409,1.1574-.2392-.0219-.483-.03-.7256-.0462-.3435,1.4132.295,2.2512,1.6155,2.0122a5.4752,5.4752,0,0,0,1.6244-.7128c.3531-.2042.6194-.354.9533-.1867a1.4717,1.4717,0,0,0,1.446.0293,1.2227,1.2227,0,0,0,.193-.1528,2.9045,2.9045,0,0,1,2.4351-.9682,3.4321,3.4321,0,0,1,.3494.0544c.0356.0074.0861-.0211.1293-.0281a10.1421,10.1421,0,0,0,5.1043-2.6252,1.1154,1.1154,0,0,1,.8661-.287c.1848.0761.1735.4813.237.7487a.8417.8417,0,0,1-.0242.24,2.4284,2.4284,0,0,0,1.6618-1.64C36.5933,32.36,36.8634,31.4138,36.0485,30.9972Zm-12.4558,1.216a11.7042,11.7042,0,0,1-.4951,2.2559c-.08.0225-.16.0444-.2394.0664a4.271,4.271,0,0,1-.1414-.8223c.0208-1.5715.0754-3.1517.0991-4.7244.0034-.2185.02-.445.0234-.6657.008-.5506.0384-.9633-.5641-1.2231a2.7966,2.7966,0,0,0-.5009-.1077c1.0662-.522.9382-1.2567.9355-1.8649q-.0123-2.9027.0018-5.8114c.0015-.2891.0658-.5933.1159-1.02a2.6851,2.6851,0,0,1,.7554,1.9873c.0045.1024.0063.2059.0074.3084C23.63,24.4557,23.6388,28.327,23.5927,32.2132Z" />
      <path class="cls-1"
        d="M53.5912,7.924c.0691-.13.1308-.235.1817-.3435.5019-1.065.111-2.6108-.7838-2.951a1.3251,1.3251,0,0,0-.668.0819.6713.6713,0,0,0-.098.3356,2.1645,2.1645,0,0,1-.0076.24c-.0474.5164-.3093.7406-.9345.8336a20.3342,20.3342,0,0,0-2.1277.3429,10.19,10.19,0,0,0-4.699,2.1289c-.5308-.5214-1.9021-.0858-2.573.6676a1.2072,1.2072,0,0,1-1.0616.4767c-1.6332-.067-2.9492.9877-3.67,2.8735-.1964.5137-.0369.6808.4471.46.3453-.158.6909-.3676,1.0338-.4825,1.0015-.3356,1.3134-.1135,1.3137.8667,0,.8929-.015,1.792-.0194,2.6869s.0015,1.7849.0433,2.66a3.3549,3.3549,0,0,1-1.0806,2.4666c-.1436.1591-.27.3353-.4918.6138.357-.0356.58-.0444.8073-.0824.6341-.1042.9228.0889.9065.8209-.0538,2.3706-.02,4.71-.02,7.0626a1.19,1.19,0,0,1-1.1763,1.2783c-.261.0213-.521.04-.7829.0609a3.2464,3.2464,0,0,0-.0982.6577c-.0235.6542.2379,1.0515.744,1.1666a1.6762,1.6762,0,0,0,.5205.0269,3.4983,3.4983,0,0,0,1.9609-.8845c.275-.2282.75-.4957.9368-.4184.9419.3885,1.7983-.0852,2.6916-1.0148a.8613.8613,0,0,1,.5538-.2581,2.9574,2.9574,0,0,0,2.986-2.2479,1.1009,1.1009,0,0,0,.04-.2352c.0167-.2347-.0283-.47-.0283-.7057a4.48,4.48,0,0,0-.8613.35c-1.4068.9205-2.3174.7-2.3665-.7431-.0662-1.9353-.05-3.9014-.0427-5.8635a1.1939,1.1939,0,0,1,.97-1.275,12.7827,12.7827,0,0,1,1.3024-.3494,2.1665,2.1665,0,0,1,.2949-.0526c.64-.0691.9509.2457.98.9855.0181.4722-.0275.9678.0018,1.4353.0117.19.1159.477.2294.4658a1.249,1.249,0,0,0,.6434-.38,1.6152,1.6152,0,0,0,.3982-.6986,14.41,14.41,0,0,0,.2861-2.0025,2.2126,2.2126,0,0,1,.4336-1.43c.1661-.2148.1931-.8382.05-.907-.6865-.3307-.6139-1.0528-.611-1.77a1.4951,1.4951,0,0,0-.8324-1.5659,2.0853,2.0853,0,0,0-.6924-.0109,3.0286,3.0286,0,0,0-.18.707c.007.5381.12,1.0439.0963,1.589a1.8067,1.8067,0,0,1-1.0311,1.6476,18.0261,18.0261,0,0,1-1.69.684c-.4491.1633-.7658.0592-.7669-.4311-.0053-2.02-.0307-4.033.0217-6.0718a2.3164,2.3164,0,0,1,1.2329-1.8545c1.714-1.022,3.6409-.9307,4.6846.2209a5.47,5.47,0,0,1,1.3193,3.5751A1.7815,1.7815,0,0,0,52.6,14.01a3.4355,3.4355,0,0,0,.728-.5257,3.01,3.01,0,0,0,.469-2.9675.7031.7031,0,0,1-.0734-.543C54.1624,9.1251,54.1694,8.4344,53.5912,7.924ZM42.0241,25.8392a13.2474,13.2474,0,0,1-.5077,2.4012c-.084.0219-.1676.0439-.2513.065a5.3912,5.3912,0,0,1-.1185-.8658c.0225-1.5752.0757-3.161.1-4.7358.0128-.8532.2555-1.56-.9062-1.6568a2.11,2.11,0,0,0,.795-2.1247q-.0136-2.8664-.0017-5.7436c.0008-.2963.05-.61.0766-.9164a2.3553,2.3553,0,0,1,.8169,2.0865C42.0557,18.1686,42.0726,21.9927,42.0241,25.8392Zm-.1947-5.0263" />
      <path class="cls-1"
        d="M70.9345,29.3329c-3.64-3.2206-11.6279-1.0071-14.1867-.3956C46.1308,31.4744,23.3943,41.528,15.3144,42.6551c-3.886.5424-7.07.2119-6.6651-.8819.8361-2.2564,1.6-5.254,2.5545-7.48a6.1973,6.1973,0,0,1,2.5368-2.1848c-.92-.8979-1.1322-1.4012-.7752-2.3957.9865-2.7477,2.5119-7.8985,3.5136-9.8986A7.8606,7.8606,0,0,1,17.5133,18.54c.1812-.2212.54-.5249.5026-.6536a.9627.9627,0,0,0-.4871-.5707.48.48,0,0,0-.0947-.0293,1.9,1.9,0,0,0-1.1646.1413.7825.7825,0,0,1-.9678-.0275,1.4639,1.4639,0,0,0-1.8113.0526,1.5227,1.5227,0,0,1-1.4761.234,17.7144,17.7144,0,0,0-7.5465-.7554,1.1824,1.1824,0,0,1-1.3523-.7318c-.208-.4423-.5166-.4793-.8063-.2967-.74.4626-.9025,2.0933-.2936,3.0934a2.1127,2.1127,0,0,0-.5273,1.3014,2.3842,2.3842,0,0,0,.3139,1.18,4.1242,4.1242,0,0,0,.2715.4384c-.91.8906-.3318,2.8392.5863,3.645.596.5191,1.073.6156,1.4731.2845a5.1991,5.1991,0,0,1-.2863-4.2162c.8253-1.9147,3.3024-2.5982,5.7356-1.9656,1.3591.3546,1.161.3494.83,1.6917a55.1017,55.1017,0,0,1-3.1543,9.17,2.8184,2.8184,0,0,1-1.99,1.44c-.174.0324-.3381.095-.5631.1568a4.0456,4.0456,0,0,0,.3487.5079c.5523.5744,1.2517,1.1706,1.0064,1.8038-1.6911,4.3687-2.1139,6.6236-3.664,10.4285-.097.2382-1.2684.4231-2.3959-.4225a2.8684,2.8684,0,0,0,.5932,1.697,2.2976,2.2976,0,0,0,2.0426.8134,3.3778,3.3778,0,0,1,1.8789.28c9.86,3.0352,20.4061-3.5884,31.1873-7.9573,4.8206-1.9539,15.3613-8.437,26.8471-9.5647.9867,1.0571,3.1.9869,3.7347,0a1.987,1.987,0,0,0,2.9809.3037,2.9986,2.9986,0,0,0,3.7837,1.2467C71.78,30.9766,71.4992,29.832,70.9345,29.3329ZM4.253,45.7156c-.8263-.3-.6445-.8924-.3794-1.4513.4218-.8894.7556-1.8116,1.0886-2.7385.571-1.5906,1.117-3.19,1.6831-4.7825.2468-.6943.4951-1.3891.767-2.0738.2345-.59.6632-1.3815-.2815-1.9845,1.6624-1.02,1.8107-2.71,2.3689-4.3055.2588-.7472,1.841-6.3106,2.0951-7.0678a5.03,5.03,0,0,1,.41-.7654l.2091.03a2.2208,2.2208,0,0,1,.0694.71c-.2577,1.0966-1.8795,6.99-2.2369,8.0426q-.9757,2.8748-1.9377,5.7544Q7.0709,38.1666,6.03,41.2489c-.2063.6121-.4365,1.2236-.6069,1.8485-.053.1949-.1.39-.1391.5875a3.7037,3.7037,0,0,0-.086.56c-.0209.426.1088.5389.483.7087,1.709.773,7.8078,1.38,16.8057-1.2857C11.918,48.381,4.6068,45.8437,4.253,45.7156Z" />
      <path class="cls-1"
        d="M43.5,37.3935c2.7909-1.1821,14.1867-6.4829,18.8114-5.2851a98.4677,98.4677,0,0,0-13.4562,4.8154c1.7854.1879,1.879,1.5037,1.3154,2.2547-.5638-1.4091-3.57-.8455-6.1069,0-5.8252,2.8189-19.26,8.55-22.1728,7.6109C24.99,46.0174,40.4133,38.701,43.5,37.3935Z" />
      <path class="cls-1"
        d="M72.5363,25.8877a1.5806,1.5806,0,0,1-1.594-1.2552,2.46,2.46,0,0,1-.0557-.3616c-.1135-1.3471-.2053-2.6918-.2563-4.0278a4.6657,4.6657,0,0,0-2.8284-4.4639,6.0021,6.0021,0,0,1-.5822-.36,4.0214,4.0214,0,0,0,.737-.3332,4.7164,4.7164,0,0,0,1.8592-2.3425c.4236-.9286.5032-2.1456,1.7929-2.3577a3.32,3.32,0,0,1-1.7355-2.3983,5.4083,5.4083,0,0,0-2.528-3.4426,6.4209,6.4209,0,0,0-6.1309-.2273,1.521,1.521,0,0,1-.2173.071C60.265.2709,54.2961-.3966,51.0165.2073,45.9313,1.1445,45.1,2.3684,29.877,9.1334a60.674,60.674,0,0,1-11.84,4.1337C13.715,14.3007,4.1317,14.3944,4.2257,10.5424,2.7223,12.5156,5.2592,15.146,7.608,14.77c.47,1.5033,2.0571.8924,3.1.1881-.6257.4223.9022,1.25,1.1577,1.2842,1.0669.1419,1.8923-.8008,2.9041-.9635.706-.1135,1.43-.1367,2.1387-.2511A31.019,31.019,0,0,0,21.6,13.8555c4.76-1.5566,11.9205-4.49,16.639-6.1315C46.53,4.84,55.5118-.1164,55.9835,7.3254c.0045.3879.0148.7468.0149,1.0142,0,1.6554-.03,3.3168.01,4.9641.0289,1.216.1237,2.3767-1.6186,3.0655a6.6562,6.6562,0,0,0,.7625.2963,1.8776,1.8776,0,0,1,.2546.0759c.5453.2113.7572.6559.7373,1.3741-.0272.9954-.0313,1.9867-.0287,2.9774s.0114,1.98.01,2.9716a1.5552,1.5552,0,0,1-1.03,1.6355,11.0665,11.0665,0,0,1-1.5336.467,1.212,1.212,0,0,0-.0085.175.9038.9038,0,0,0,.5735.8221,2.56,2.56,0,0,0,2.1212.0188,3.0422,3.0422,0,0,0,.3053-.1463c.0409-.0217.0813-.0445.1208-.0656.5954-.3218,1.0672-.5412,1.6547-.1275.1983.1387.7141-.0667,1.0553-.203a4.5968,4.5968,0,0,0,.8172-.5535,8.752,8.752,0,0,0,.8966.4541A1.8368,1.8368,0,0,0,63.52,25.3119c.1209-.5723-.0623-.7654-.6194-.6344a1.2954,1.2954,0,0,1-1.6859-1.3014c-.0064-1.8509-.0021-3.7024-.0023-5.5539V17.026a1.0874,1.0874,0,0,1,.2022-.0773c.61-.0384,1.2195-.0623,1.8289-.067a1.6584,1.6584,0,0,1,1.7445,1.2063,5.2372,5.2372,0,0,1,.24,1.4114c.1083,1.9393.1735,3.88.2832,5.819.046.8122.3348,1.1435,1.12,1.2283.052.0058.1042.0105.1562.0134a4.9961,4.9961,0,0,1,2.3512.292.5161.5161,0,0,0,.4851-.052c.3523-.3165.6812-.05,1.0476.1638,1.0664.6232,1.989.55,2.396-.2621a1.9174,1.9174,0,0,0,.0731-.59A2.4645,2.4645,0,0,0,72.5363,25.8877Zm-14.71-3.0915a9.2951,9.2951,0,0,1-.1817,1.2832q-.1347.04-.2695.08a4.5845,4.5845,0,0,1-.3116-.8186.83.83,0,0,1-.01-.1217c-.0033-1.827.0574-3.6633.0652-5.4914.0024-.5394-.2111-1.1979-.5925-1.35a2.092,2.092,0,0,1-.2878-.1258,1.7205,1.7205,0,0,0,.5779-.68,1.6251,1.6251,0,0,0,.0622-.1561c.0053-.0174.0148-.0317.02-.05l.0035-.0213a3.6105,3.6105,0,0,0,.1255-.9629c.0088-1.6748-.1808-3.3644-.1731-5.0246.0087-1.8846-.0551-4.0524-1.186-5.6587-1.053-1.4957-3.1189-1.6558-4.7457-1.33a40.4846,40.4846,0,0,0-4.7912,1.4093c2.63-2.2547,7.8794-2.9627,9.5407-1.5145,2.2588,1.9692,2.0148,3.863,2.109,7.3394.0219.823.0479,2.4182.0508,3.2415C57.8426,16.1616,57.835,19.4788,57.8262,22.7962Zm6.8262-9.6828c-.0171,1.0881-.5609,1.5428-1.6345,1.5586-.1308.0021-.2612.0041-.392.0073-1.2263.0355-1.4033-.1149-1.4115-1.3886-.0064-.9573-.0011-1.9156-.0011-2.8735,0-1.0232-.0065-2.0457.0023-3.069a1.0089,1.0089,0,0,1,1.0767-1.1367c1.5479-.09,2.2658.5744,2.3258,2.1356C64.6786,9.9353,64.6769,11.5261,64.6523,13.1134Zm.9093-5.884c1.3684.4943,1.4416,5.2923.3094,6.3463C65.767,11.4471,65.6647,9.34,65.5616,7.2294Zm1.9054,18.069a.2073.2073,0,0,1-.0456.0076.4626.4626,0,0,1-.3534-.1382,2.6043,2.6043,0,0,1-.3433-.9158c-.1126-1.2863-.1489-2.5718-.2692-3.8575-.0725-.773-.2482-1.5448-.3771-2.3162q-.0548-.3256-.1091-.6523c.09-.0357.1793-.0705.269-.1054a4.6088,4.6088,0,0,1,.7033,1.182,24.2484,24.2484,0,0,1,.5249,3.12c.113,1.1089.1211,2.2184.1586,3.3256C67.6291,25.0761,67.5583,25.2674,67.467,25.2984Z" />
      <path class="cls-1"
        d="M47.9162.02C41.5273,1.711,33.823,6.2206,29.0314,8.2878,22.4287,11.136,16.06,12.7611,13.3977,12.9735c-2.5014.2-5.4609.2583-7.1991-1.21A3.1557,3.1557,0,0,1,5.8228,7.16c.8633-.99,2.8186-1.5031,3.3825-.3877a1.2624,1.2624,0,0,0,1.3389.81A1.8511,1.8511,0,0,1,8.0776,9.2273c-.6088-.4494-.9237-1.78-1.691-.94a1.6477,1.6477,0,0,0-.0939,2.2547c2.63,3.2883,11.2449,1.11,13.9052-.9512A1.8555,1.8555,0,0,1,18.62,7.5457c2.2678,1.5361,6.5514.4128,8.72-.4795C33.0049,4.7357,44.064-.3562,47.9162.02Z" />
    </g>
  </g>
</svg>
            
        </a>
    </h1>
    <a id="search" class="dosearch" role="button">
        <svg class="icon-search"><use xlink:href="#icon-search"></use></svg>
    </a>
    
</header>

<div id="mask" class="overlay"></div>

<aside class="sidebar" id="sidebar">
    <nav id="navigation">
      <h2>Menu</h2>
      <ul>
  
</ul>

    </nav>
</aside>

<div class="search-wrapper">
    <div class="search-form">
        <input type="text" class="search-field" placeholder="Search">
        <svg class="icon-remove-sign"><use xlink:href="#icon-close"></use></svg>
        <ul class="search-results search-list"></ul>
    </div>
</div>



        <section class="post one-column">
            <article role="article" class="post-content">
                <p class="post-info">
                    
                        <svg class="icon-calendar" id="date"><use xlink:href="#icon-calendar"></use></svg>
                        <time class="date" datetime="2020-07-21T00:00:00-07:00">
                            


July 21, 2020

                        </time>
                    
                    <svg id="clock" class="icon-clock"><use xlink:href="#icon-clock"></use></svg>
                    <span>13 min to read</span>
                </p>
                <h1 class="post-title">Example of GPU usage in Metaflow</h1>
                <p class="post-subtitle"></p>

                
                    <img src="/blog-theme/assets/img/posts/example-of-gpu-usage-in-metaflow/metaflow.jpg" alt="Featured image" class="post-cover">
                

                <!-- Pagination links -->



                <!-- Add your table of contents here -->


                <p>The <code class="language-plaintext highlighter-rouge">test_metaflow_gpu.py</code> contains an example of how to allocate
GPU resources and make use of it for deep learning in Metaflow.</p>

<p>GPU usage for deep learning is not trivial in Metaflow due to
the fact that one needs to install CUDA in a correct way and
expose the GPU hardwares to the container that runs Metaflow steps.</p>

<p>Core setup (in Metaflow) is to use the <code class="language-plaintext highlighter-rouge">resource(gpu=N)</code> decorator
for EC2 resources and the <code class="language-plaintext highlighter-rouge">batch(..., image=IMAGE_WITH_CUDA)</code> decorator
(or the use no image and set up CUDA/NVIDIA environment variables with
<a href="https://docs.metaflow.org/introduction/release-notes#2-2-8-mar-15th-2021">Metaflow(&gt;=2.2.8)</a>
<code class="language-plaintext highlighter-rouge">@environment</code> decorator) for AWS Batch resources</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">@</span><span class="n">batch</span><span class="p">(</span>
    <span class="n">cpu</span><span class="o">~|=|</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">gpu</span><span class="o">~|=|</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">memory</span><span class="o">~|=|</span><span class="mi">2400</span><span class="p">,</span>
    <span class="o">~|</span><span class="c1">#| This image can work without the @environment decorator because NVIDIA and CUDA related environment
</span>    <span class="o">~|</span><span class="c1">#| variables have been set up in the docker
</span>    <span class="o">~|</span><span class="c1">#| image~|=|"763104351884.dkr.ecr.us~|-|east~|-|1.amazonaws.com/pytorch~|-|training:1.7.1~|-|gpu~|-|py36~|-|cu110~|-|ubuntu18.04"
</span><span class="p">)</span>
<span class="o">@</span><span class="n">environment</span><span class="p">(</span>
    <span class="o">~|</span><span class="c1">#| environment decorator is used to set up global system level
</span>    <span class="o">~|</span><span class="c1">#| environment variables
</span>    <span class="nb">vars</span><span class="o">~|=|</span><span class="p">{</span>
        <span class="s">'NVIDIA_DRIVER_CAPABILITIES'</span><span class="p">:</span> <span class="s">'compute,utility'</span><span class="p">,</span>  <span class="o">~|</span><span class="c1">#| necessary to allow computation on GPUs
</span>        <span class="s">'CUDA_VISIBLE_DEVICES'</span><span class="p">:</span> <span class="s">'0,1'</span><span class="p">,</span>  <span class="o">~|</span><span class="c1">#| make two CUDA devices visible
</span>    <span class="p">}</span>
<span class="p">)</span>
<span class="o">@</span><span class="n">conda</span><span class="p">(</span><span class="n">libraries</span><span class="o">~|=|</span><span class="p">{</span>
    <span class="s">'pytorch::pytorch'</span><span class="p">:</span> <span class="s">'1.7.1'</span><span class="p">,</span>  <span class="o">~|</span><span class="c1">#| need this conda decorator to install pytorch.
</span>    <span class="o">~|</span><span class="c1">#| Metaflow will not automatically recognize the pytorch installed in the above image
</span>    <span class="o">~|</span><span class="c1">#| because it will create its own conda env
</span>    <span class="o">~|</span><span class="c1">#| The first pytorch before '::' is the pytorch conda channel
</span>    <span class="o">~|</span><span class="c1">#| One wants to install from that channel for CUDA support
</span>    <span class="o">~|</span><span class="c1">#| The conda~|-|forge channel's pytorch doesn't come with CUDA support
</span><span class="p">})</span>
<span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="p">...</span>
</code></pre></div></div>

<p>The image <code class="language-plaintext highlighter-rouge">763104351884.dkr.ecr.us-east-1.amazonaws.com/pytorch-training:1.6.0-gpu-py36-cu110-ubuntu18.04</code> used above can be obtained from <a href="https://github.com/aws/deep-learning-containers/blob/master/available_images.md">Amazon Deep Learning Images</a> project. A variety of deep learning images with different types of deep learning frameworks (Tensorflow, Pytorch, etc), different CUDA versions (CUDA10, CUDA11) are provided.</p>

<h2 id="how-to-run">How to run</h2>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>USERNAME~|<span class="o">=</span>|YOURUSERNAME CONDA_CHANNELS~|<span class="o">=</span>|default,pytorch,conda~|-|forge METAFLOW_PROFILE~|<span class="o">=</span>|ds~|-|dev AWS_PROFILE~|<span class="o">=</span>|ds~|-|dev~|-|admin python test_metaflow_gpu.py ~|-|~|-|environment~|<span class="o">=</span>|conda run
</code></pre></div></div>

<p>For how to setup the <code class="language-plaintext highlighter-rouge">METAFLOW_PROFILE</code> and <code class="language-plaintext highlighter-rouge">AWS_PROFILE</code>, refer to the <a href="../../local_dev">local_dev</a> folder.</p>

<p>Expected result should be</p>

<details>
    <summary>Expected output (click to expand)</summary>

```shell
(base) root@2b15d8a4c149:/ds~|-|model~|-|mlm~|-|metaflow/tests/test_metaflow_gpu~|#| USERNAME~|=|bz CONDA_CHANNELS~|=|default,pytorch,conda~|-|forge METAFLOW_PROFILE~|=|ds~|-|dev AWS_PROFILE~|=|ds~|-|dev~|-|admin python test_metaflow_gpu.py ~|-|~|-|environment~|=|conda run
Metaflow 2.2.7 executing TestGPUFlow for user:bz
Validating your flow...
    The graph looks good!
Running pylint...
    Pylint is happy!
Bootstrapping conda environment...(this could take a few minutes)
2021~|-|03~|-|12 04:51:56.446 Workflow starting (run~|-|id 129):
2021~|-|03~|-|12 04:52:00.209 [129/start/1341 (pid 5161)] Task is starting.
2021~|-|03~|-|12 04:52:02.427 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] Task is starting (status SUBMITTED)...
2021~|-|03~|-|12 04:52:04.723 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] Task is starting (status RUNNABLE)...
2021~|-|03~|-|12 04:52:34.796 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] Task is starting (status RUNNABLE)...
2021~|-|03~|-|12 04:53:04.927 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] Task is starting (status RUNNABLE)...
2021~|-|03~|-|12 04:53:35.036 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] Task is starting (status RUNNABLE)...
2021~|-|03~|-|12 04:54:05.230 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] Task is starting (status RUNNABLE)...
2021~|-|03~|-|12 04:54:35.386 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] Task is starting (status RUNNABLE)...
2021~|-|03~|-|12 04:54:45.615 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] Task is starting (status STARTING)...
2021~|-|03~|-|12 04:55:15.622 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] Task is starting (status STARTING)...
2021~|-|03~|-|12 04:55:45.627 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] Task is starting (status STARTING)...
2021~|-|03~|-|12 04:56:15.788 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] Task is starting (status STARTING)...
2021~|-|03~|-|12 04:56:45.927 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] Task is starting (status STARTING)...
2021~|-|03~|-|12 04:57:16.127 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] Task is starting (status STARTING)...
2021~|-|03~|-|12 04:57:46.147 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] Task is starting (status STARTING)...
2021~|-|03~|-|12 04:58:15.881 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] Task is starting (status RUNNING)...
2021~|-|03~|-|12 04:58:20.154 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] bash: cannot set terminal process group (~|-|1): Inappropriate ioctl for device
2021~|-|03~|-|12 04:58:20.155 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] bash: no job control in this shell
2021~|-|03~|-|12 04:58:20.156 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] AWS_BATCH_CE_NAME~|=|'MetaflowComputeEnvironment'
2021~|-|03~|-|12 04:58:20.156 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] AWS_BATCH_JOB_ATTEMPT~|=|'1'
2021~|-|03~|-|12 04:58:20.157 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] AWS_BATCH_JOB_ID~|=|'931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226'
2021~|-|03~|-|12 04:58:20.158 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] AWS_BATCH_JQ_NAME~|=|'job~|-|queue~|-|metaflow~|-|infrastructure'
2021~|-|03~|-|12 04:58:20.158 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] AWS_CONTAINER_CREDENTIALS_RELATIVE_URI~|=|'/v2/credentials/0a3ac1ce~|-|0a34~|-|41bc~|-|a916~|-|e2cf51a907c0'
2021~|-|03~|-|12 04:58:20.159 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] AWS_DEFAULT_REGION~|=|'us~|-|east~|-|1'
2021~|-|03~|-|12 04:58:20.160 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] AWS_EXECUTION_ENV~|=|'AWS_ECS_EC2'
2021~|-|03~|-|12 04:58:20.160 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] CMAKE_PREFIX_PATH~|=|'$(dirname $(which conda))/../'
2021~|-|03~|-|12 04:58:20.161 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] CUDA_VERSION~|=|'11.0.3'
2021~|-|03~|-|12 04:58:20.161 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] CUDNN_VERSION~|=|'8.0.4.30'
2021~|-|03~|-|12 04:58:20.162 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] DGLBACKEND~|=|'pytorch'
2021~|-|03~|-|12 04:58:20.162 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] ECS_CONTAINER_METADATA_URI~|=|'http://169.254.170.2/v3/615eaa62~|-|7e66~|-|46b8~|-|9b7f~|-|feafa2874358'
2021~|-|03~|-|12 04:58:20.162 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] ECS_CONTAINER_METADATA_URI_V4~|=|'http://169.254.170.2/v4/615eaa62~|-|7e66~|-|46b8~|-|9b7f~|-|feafa2874358'
2021~|-|03~|-|12 04:58:20.163 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] HOME~|=|'/root'
2021~|-|03~|-|12 04:58:20.163 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] HOROVOD_VERSION~|=|'0.20.3'
2021~|-|03~|-|12 04:58:20.164 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] HOSTNAME~|=|'ip~|-|10~|-|13~|-|90~|-|128.ec2.internal'
2021~|-|03~|-|12 04:58:20.164 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] IFS~|=|'
2021~|-|03~|-|12 04:58:20.165 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] '
2021~|-|03~|-|12 04:58:22.935 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] LANG~|=|'C.UTF~|-|8'
2021~|-|03~|-|12 04:58:22.936 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] LC_ALL~|=|'C.UTF~|-|8'
2021~|-|03~|-|12 04:58:22.937 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] LD_LIBRARY_PATH~|=|'/opt/conda/lib/python3.6/site~|-|packages/smdistributed/dataparallel/lib:/home/.openmpi/lib/:/opt/conda/lib:/usr/local/lib:/usr/local/nvidia/lib:/usr/local/nvidia/lib64'
2021~|-|03~|-|12 04:58:22.938 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] LIBRARY_PATH~|=|'/usr/local/cuda/lib64/stubs'
2021~|-|03~|-|12 04:58:22.939 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] MANUAL_BUILD~|=|'0'
2021~|-|03~|-|12 04:58:22.940 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] METAFLOW_CODE_DS~|=|'s3'
2021~|-|03~|-|12 04:58:22.940 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] METAFLOW_CODE_SHA~|=|'0cade183b6e658b8d9b0343997eace8b235334cf'
2021~|-|03~|-|12 04:58:22.941 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] METAFLOW_CODE_URL~|=|'s3://zefr~|-|ds~|-|dev~|-|use1~|-|865426939207~|-|s3~|-|metaflow/metaflow/TestGPUFlow/data/0c/0cade183b6e658b8d9b0343997eace8b235334cf'
2021~|-|03~|-|12 04:58:22.942 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] METAFLOW_DATASTORE_SYSROOT_S3~|=|'s3://zefr~|-|ds~|-|dev~|-|use1~|-|865426939207~|-|s3~|-|metaflow/metaflow'
2021~|-|03~|-|12 04:58:22.943 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] METAFLOW_DATATOOLS_S3ROOT~|=|'s3://zefr~|-|ds~|-|dev~|-|use1~|-|865426939207~|-|s3~|-|metaflow/metaflow/data'
2021~|-|03~|-|12 04:58:22.944 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] METAFLOW_DEFAULT_DATASTORE~|=|'s3'
2021~|-|03~|-|12 04:58:22.944 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] METAFLOW_DEFAULT_METADATA~|=|'service'
2021~|-|03~|-|12 04:58:22.945 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] METAFLOW_INPUT_PATHS_0~|=|'129/_parameters/1340'
2021~|-|03~|-|12 04:58:22.946 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] METAFLOW_SERVICE_HEADERS~|=|'{}'
2021~|-|03~|-|12 04:58:22.948 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] METAFLOW_SERVICE_URL~|=|'http://tf~|-|lb~|-|20210225192300834700000001~|-|bb0309f275885bf4.elb.us~|-|east~|-|1.amazonaws.com/'
2021~|-|03~|-|12 04:58:22.949 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] METAFLOW_USER~|=|'bz'
2021~|-|03~|-|12 04:58:22.950 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] NCCL_VERSION~|=|'2.7.8'
2021~|-|03~|-|12 04:58:22.951 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] NVIDIA_DRIVER_CAPABILITIES~|=|'compute,utility'
2021~|-|03~|-|12 04:58:22.951 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] NVIDIA_REQUIRE_CUDA~|=|'cuda&gt;~|=|11.0 brand~|=|tesla,driver&gt;~|=|418,driver~|&lt;|419 brand~|=|tesla,driver&gt;~|=|440,driver~|&lt;|441 brand~|=|tesla,driver&gt;~|=|450,driver~|&lt;|451'
2021~|-|03~|-|12 04:58:22.952 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] NVIDIA_VISIBLE_DEVICES~|=|'GPU~|-|4d88dac3~|-|b808~|-|8c02~|-|30cb~|-|817671287688'
2021~|-|03~|-|12 04:58:22.953 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] OPTIND~|=|'1'
2021~|-|03~|-|12 04:58:22.955 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] PATH~|=|'/home/.openmpi/bin:/opt/conda/bin:/usr/local/nvidia/bin:/usr/local/cuda/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin'
2021~|-|03~|-|12 04:58:22.955 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] PPID~|=|'1'
2021~|-|03~|-|12 04:58:22.956 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] PS1~|=|'~|#| '
2021~|-|03~|-|12 04:58:22.958 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] PS2~|=|'&gt; '
2021~|-|03~|-|12 04:58:22.958 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] PS4~|=|'+ '
2021~|-|03~|-|12 04:58:22.960 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] PWD~|=|'/'
2021~|-|03~|-|12 04:58:22.960 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] PYTHONDONTWRITEBYTECODE~|=|'1'
2021~|-|03~|-|12 04:58:22.961 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] PYTHONIOENCODING~|=|'UTF~|-|8'
2021~|-|03~|-|12 04:58:22.962 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] PYTHONUNBUFFERED~|=|'1'
2021~|-|03~|-|12 04:58:22.963 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] SAGEMAKER_TRAINING_MODULE~|=|'sagemaker_pytorch_container.training:main'
2021~|-|03~|-|12 04:58:22.964 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] SHLVL~|=|'1'
2021~|-|03~|-|12 04:58:22.965 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] TORCH_CUDA_ARCH_LIST~|=|'3.5 3.7 5.2 6.0 6.1 7.0+PTX 8.0'
2021~|-|03~|-|12 04:58:22.966 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] TORCH_NVCC_FLAGS~|=|'~|-|Xfatbin ~|-|compress~|-|all'
2021~|-|03~|-|12 04:58:22.967 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] _~|=|'/bin/sh'
2021~|-|03~|-|12 04:58:22.968 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] Setting up task environment.
2021~|-|03~|-|12 04:58:22.970 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] Downloading code package.
2021~|-|03~|-|12 04:58:22.970 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] Code package downloaded.
2021~|-|03~|-|12 05:02:12.929 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] Bootstrapping environment.
2021~|-|03~|-|12 05:02:12.929 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] Environment bootstrapped.
2021~|-|03~|-|12 05:02:18.122 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] Task is starting.
2021~|-|03~|-|12 05:02:18.122 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] Fri Mar 12 05:02:15 2021
2021~|-|03~|-|12 05:02:18.122 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] +~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|+
2021~|-|03~|-|12 05:02:18.123 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] | NVIDIA~|-|SMI 450.51.06    Driver Version: 450.51.06    CUDA Version: 11.0     |
2021~|-|03~|-|12 05:02:18.123 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] |~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|+~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|+~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|+
2021~|-|03~|-|12 05:02:18.123 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] | GPU  Name        Persistence~|-|M| Bus~|-|Id        Disp.A | Volatile Uncorr. ECC |
2021~|-|03~|-|12 05:02:18.124 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] | Fan  Temp  Perf  Pwr:Usage/Cap|         Memory~|-|Usage | GPU~|-|Util  Compute M. |
2021~|-|03~|-|12 05:02:18.124 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] |                               |                      |               MIG M. |
2021~|-|03~|-|12 05:02:18.124 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] |~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|+~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|+~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=||
2021~|-|03~|-|12 05:02:18.125 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] |   0  Tesla V100~|-|SXM2...  Off  | 00000000:00:1E.0 Off |                    0 |
2021~|-|03~|-|12 05:02:18.125 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] | N/A   35C    P0    39W / 300W |      0MiB / 16160MiB |      0%      Default |
2021~|-|03~|-|12 05:02:18.125 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] |                               |                      |                  N/A |
2021~|-|03~|-|12 05:02:18.125 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] +~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|+~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|+~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|+
2021~|-|03~|-|12 05:02:18.126 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226]
2021~|-|03~|-|12 05:02:19.480 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] +~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|+
2021~|-|03~|-|12 05:02:19.480 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] | Processes:                                                                  |
2021~|-|03~|-|12 05:02:19.480 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] |  GPU   GI   CI        PID   Type   Process name                  GPU Memory |
2021~|-|03~|-|12 05:02:19.481 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] |        ID   ID                                                   Usage      |
2021~|-|03~|-|12 05:02:19.481 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] |~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=||
2021~|-|03~|-|12 05:02:19.481 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] |  No running processes found                                                 |
2021~|-|03~|-|12 05:02:19.481 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] +~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|+
2021~|-|03~|-|12 05:02:19.481 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] nvcc: NVIDIA (R) Cuda compiler driver
2021~|-|03~|-|12 05:02:19.481 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] Copyright (c) 2005~|-|2020 NVIDIA Corporation
2021~|-|03~|-|12 05:02:19.482 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] Built on Wed_Jul_22_19:09:09_PDT_2020
2021~|-|03~|-|12 05:02:19.482 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] Cuda compilation tools, release 11.0, V11.0.221
2021~|-|03~|-|12 05:02:19.482 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] Build cuda_11.0_bu.TC445_37.28845127_0
2021~|-|03~|-|12 05:02:19.482 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] __Python VERSION: 3.6.11 | packaged by conda~|-|forge | (default, Nov 27 2020, 18:57:37)
2021~|-|03~|-|12 05:02:19.482 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] [GCC 9.3.0]
2021~|-|03~|-|12 05:02:19.482 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] __pyTorch VERSION: 1.6.0
2021~|-|03~|-|12 05:02:19.482 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] __CUDA VERSION 10.2
2021~|-|03~|-|12 05:02:19.483 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] __CUDNN VERSION: 7605
2021~|-|03~|-|12 05:02:19.483 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] __Number CUDA Devices: 1
2021~|-|03~|-|12 05:02:21.931 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] __Devices
2021~|-|03~|-|12 05:02:21.931 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] index, name, driver_version, memory.total [MiB], memory.used [MiB], memory.free [MiB]
2021~|-|03~|-|12 05:02:21.932 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] 0, Tesla V100~|-|SXM2~|-|16GB, 450.51.06, 16160 MiB, 2 MiB, 16158 MiB
2021~|-|03~|-|12 05:02:21.932 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] Active CUDA Device: GPU 0
2021~|-|03~|-|12 05:02:21.932 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] Available devices  1
2021~|-|03~|-|12 05:02:21.932 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] Current cuda device  0
2021~|-|03~|-|12 05:02:21.932 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] GPU count: 1
2021~|-|03~|-|12 05:02:21.932 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] Task finished with exit code 0.
2021~|-|03~|-|12 05:02:25.812 [129/start/1341 (pid 5161)] Task finished successfully.
2021~|-|03~|-|12 05:02:28.636 [129/end/1342 (pid 5193)] Task is starting.
2021~|-|03~|-|12 05:02:39.328 [129/end/1342 (pid 5193)] Task finished successfully.
2021~|-|03~|-|12 05:02:39.766 Done!
```

</details>

<p>Some key information to check from the above output is
<img src="/blog-theme/assets/img/posts/example-of-gpu-usage-in-metaflow/test_gpu_script_output.png" alt="img.png" /></p>

<h2 id="how-does-it-work">How does it work?</h2>
<h3 id="nvidia-driver">NVIDIA Driver</h3>

<p>The <code class="language-plaintext highlighter-rouge">NVIDIA-SMI</code> (represents the installation of NVIDIA driver) is obtained at EC2 instance level. Metaflow automatically picks an AMI with NVIDIA driver installed for your batch job when you request <code class="language-plaintext highlighter-rouge">resources(gpu=N)</code>. <strong>Note that this WILL NOT happen if you dont have P2 or P3 instances in your Metaflow compute environment</strong></p>

<p>How to check P-series instances? Simply look at your compute environment
<img src="/blog-theme/assets/img/posts/example-of-gpu-usage-in-metaflow/compute_env_instances.png" alt="img_1.png" /></p>

<h3 id="cuda-toolkit">CUDA Toolkit</h3>

<p>This should come with the image used. The example image above <code class="language-plaintext highlighter-rouge">763104351884.dkr.ecr.us-east-1.amazonaws.com/pytorch-training:1.6.0-gpu-py36-cu110-ubuntu18.04</code> has CUDA installed.</p>

<h4 id="failed-example">Failed Example</h4>

<p>If one wants to install CUDA through the <code class="language-plaintext highlighter-rouge">@conda</code> decorator in Metaflow, it sometimes <strong>CAN FAIL</strong>. To try, one can replace the decorator in the <code class="language-plaintext highlighter-rouge">test_gpu_script_output.py</code> with the following</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s">"""This will fail due to conflict version"""</span>

<span class="o">@</span><span class="n">batch</span><span class="p">(</span>
    <span class="n">cpu</span><span class="o">~|=|</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">gpu</span><span class="o">~|=|</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">memory</span><span class="o">~|=|</span><span class="mi">2400</span><span class="p">,</span>
    <span class="n">image</span><span class="o">~|=|</span><span class="s">"763104351884.dkr.ecr.us~|-|east~|-|1.amazonaws.com/pytorch~|-|training:1.6.0~|-|gpu~|-|py36~|-|cu110~|-|ubuntu18.04"</span>
<span class="p">)</span>
<span class="o">@</span><span class="n">conda</span><span class="p">(</span><span class="n">libraries</span><span class="o">~|=|</span><span class="p">{</span>
    <span class="s">'pytorch::pytorch'</span><span class="p">:</span> <span class="s">'1.6.0'</span><span class="p">,</span>  <span class="o">~|</span><span class="c1">#| need this conda decorator to install pytorch.
</span>    <span class="o">~|</span><span class="c1">#| Metaflow will not automatically recognize the pytorch installed in the above image
</span>    <span class="o">~|</span><span class="c1">#| because it will create its own conda env
</span>    <span class="o">~|</span><span class="c1">#| The first pytorch before '::' is the pytorch conda channel
</span>    <span class="o">~|</span><span class="c1">#| One wants to install from that channel for GPU support
</span>    <span class="o">~|</span><span class="c1">#| The conda~|-|forge channel's pytorch doesn't come with GPU support
</span>    <span class="s">'anaconda::cudatoolkit'</span><span class="p">:</span> <span class="s">'11.0.221'</span>
    <span class="o">~|</span><span class="c1">#| To find cudatoolkit version. Use `conda search cudatoolkit ~|-|c pytorch ~|-|c conda~|-|forge ~|-|c anaconda
</span><span class="p">})</span>
<span class="o">@</span><span class="n">step</span>
<span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="p">...</span>
</code></pre></div></div>

<p>Expected output should be</p>

<details>
    <summary>Expected output (click to expand)</summary>

```shell
(base) root@2b15d8a4c149:/ds~|-|model~|-|mlm~|-|metaflow/tests/test_metaflow_gpu~|#| USERNAME~|=|bz CONDA_CHANNELS~|=|default,pytorch,conda~|-|forge METAFLOW_PROFILE~|=|ds~|-|dev AWS_PROFILE~|=|ds~|-|dev~|-|admin python test_metaflow_gpu.py ~|-|~|-|environment~|=|conda run
Metaflow 2.2.7 executing TestGPUFlow for user:bz
Validating your flow...
    The graph looks good!
Running pylint...
    Pylint is happy!
Bootstrapping conda environment...(this could take a few minutes)
    Conda ran into an error while setting up environment.:
    Step: start, Error: UnsatisfiableError: The following specifications were found to be incompatible with each other:

    Output in format: Requested package ~|-|&gt; Available versions

    Package libstdcxx~|-|ng conflicts for:
    python~|=|~|=|3.6.11 ~|-|&gt; libstdcxx~|-|ng[version~|=|'&gt;~|=|7.5.0|&gt;~|=|9.3.0']
    python~|=|~|=|3.6.11 ~|-|&gt; libffi[version~|=|'&gt;~|=|3.3,~|&lt;|3.4.0a0'] ~|-|&gt; libstdcxx~|-|ng[version~|=|'7.2.0.|&gt;~|=|4.9|&gt;~|=|7.3.0|&gt;~|=|7.2.0']

    Package cudatoolkit conflicts for:
    pytorch::pytorch~|=|~|=|1.6.0 ~|-|&gt; cudatoolkit[version~|=|'&gt;~|=|10.1,~|&lt;|10.2|&gt;~|=|10.2,~|&lt;|10.3|&gt;~|=|9.2,~|&lt;|9.3']
    anaconda|anaconda::cudatoolkit~|=|~|=|11.0.221
    anaconda::cudatoolkit~|=|~|=|11.0.221

    Package libgcc~|-|ng conflicts for:
    python~|=|~|=|3.6.11 ~|-|&gt; libffi[version~|=|'&gt;~|=|3.3,~|&lt;|3.4.0a0'] ~|-|&gt; libgcc~|-|ng[version~|=|'7.2.0.|&gt;~|=|4.9|&gt;~|=|7.3.0|&gt;~|=|7.2.0']
    coverage~|=|~|=|4.5.4 ~|-|&gt; libgcc~|-|ng[version~|=|'&gt;~|=|7.3.0']
    pytorch::pytorch~|=|~|=|1.6.0 ~|-|&gt; blas~|=|[build~|=|mkl] ~|-|&gt; libgcc~|-|ng[version~|=|'7.2.0.|&gt;~|=|4.9|&gt;~|=|7.2.0|&gt;~|=|7.3.0|&gt;~|=|7.5.0|&gt;~|=|9.3.0']
    anaconda::cudatoolkit~|=|~|=|11.0.221 ~|-|&gt; libgcc~|-|ng[version~|=|'&gt;~|=|7.3.0']
    requests~|=|~|=|2.24.0 ~|-|&gt; python ~|-|&gt; libgcc~|-|ng[version~|=|'7.2.0.|&gt;~|=|4.9|&gt;~|=|7.3.0|&gt;~|=|7.5.0|&gt;~|=|9.3.0|&gt;~|=|7.2.0']
    boto3~|=|~|=|1.14.47 ~|-|&gt; python ~|-|&gt; libgcc~|-|ng[version~|=|'7.2.0.|&gt;~|=|4.9|&gt;~|=|7.3.0|&gt;~|=|7.5.0|&gt;~|=|9.3.0|&gt;~|=|7.2.0']
    python~|=|~|=|3.6.11 ~|-|&gt; libgcc~|-|ng[version~|=|'&gt;~|=|7.5.0|&gt;~|=|9.3.0']
    click~|=|~|=|7.1.2 ~|-|&gt; python ~|-|&gt; libgcc~|-|ng[version~|=|'7.2.0.|&gt;~|=|4.9|&gt;~|=|7.3.0|&gt;~|=|7.5.0|&gt;~|=|9.3.0|&gt;~|=|7.2.0']
    coverage~|=|~|=|4.5.4 ~|-|&gt; python[version~|=|'&gt;~|=|3.8,~|&lt;|3.9.0a0'] ~|-|&gt; libgcc~|-|ng[version~|=|'7.2.0.|&gt;~|=|4.9|&gt;~|=|7.5.0|&gt;~|=|9.3.0|&gt;~|=|7.2.0']

    Package _libgcc_mutex conflicts for:
    anaconda::cudatoolkit~|=|~|=|11.0.221 ~|-|&gt; libgcc~|-|ng[version~|=|'&gt;~|=|7.3.0'] ~|-|&gt; _libgcc_mutex[version~|=|'|0.1',build~|=|'conda_forge|main']
    coverage~|=|~|=|4.5.4 ~|-|&gt; libgcc~|-|ng[version~|=|'&gt;~|=|7.3.0'] ~|-|&gt; _libgcc_mutex[version~|=|'|0.1',build~|=|'conda_forge|main']
    python~|=|~|=|3.6.11 ~|-|&gt; libgcc~|-|ng[version~|=|'&gt;~|=|9.3.0'] ~|-|&gt; _libgcc_mutex[version~|=|'|0.1',build~|=|'conda_forge|main']

    Package tzdata conflicts for:
    click~|=|~|=|7.1.2 ~|-|&gt; python ~|-|&gt; tzdata
    boto3~|=|~|=|1.14.47 ~|-|&gt; python ~|-|&gt; tzdata
    requests~|=|~|=|2.24.0 ~|-|&gt; python ~|-|&gt; tzdata

    Package urllib3 conflicts for:
    boto3~|=|~|=|1.14.47 ~|-|&gt; botocore[version~|=|'&gt;~|=|1.17.47,~|&lt;|1.18.0'] ~|-|&gt; urllib3[version~|=|'&gt;~|=|1.20,~|&lt;|1.26']
    requests~|=|~|=|2.24.0 ~|-|&gt; urllib3[version~|=|'&gt;~|=|1.21.1,~|&lt;|1.26,!~|=|1.25.0,!~|=|1.25.1']

    Package python conflicts for:
    click~|=|~|=|7.1.2 ~|-|&gt; python
    boto3~|=|~|=|1.14.47 ~|-|&gt; python
    pytorch::pytorch~|=|~|=|1.6.0 ~|-|&gt; python[version~|=|'&gt;~|=|3.6,~|&lt;|3.7.0a0|&gt;~|=|3.7,~|&lt;|3.8.0a0|&gt;~|=|3.8,~|&lt;|3.9.0a0']
    coverage~|=|~|=|4.5.4 ~|-|&gt; python[version~|=|'&gt;~|=|2.7,~|&lt;|2.8.0a0|&gt;~|=|3.6,~|&lt;|3.7.0a0|&gt;~|=|3.7,~|&lt;|3.8.0a0|&gt;~|=|3.8,~|&lt;|3.9.0a0']
    boto3~|=|~|=|1.14.47 ~|-|&gt; jmespath[version~|=|'&gt;~|=|0.7.1,~|&lt;|1.0.0'] ~|-|&gt; python[version~|=|'2.7.|3.5.|3.6.|3.4.|&gt;~|=|3.5,~|&lt;|3.6.0a0|&gt;~|=|3.7,~|&lt;|3.8.0a0|&gt;~|=|2.7,~|&lt;|2.8.0a0|&gt;~|=|3.6,~|&lt;|3.7.0a0|&gt;~|=|3|&gt;~|=|3.8,~|&lt;|3.9.0a0|&gt;~|=|3.9,~|&lt;|3.10.0a0']
    requests~|=|~|=|2.24.0 ~|-|&gt; certifi[version~|=|'&gt;~|=|2017.4.17'] ~|-|&gt; python[version~|=|'2.7.|3.5.|3.6.|&gt;~|=|2.7,~|&lt;|2.8.0a0|&gt;~|=|3.6,~|&lt;|3.7.0a0|&gt;~|=|3.7,~|&lt;|3.8.0a0|&gt;~|=|3.9,~|&lt;|3.10.0a0|&gt;~|=|3.8,~|&lt;|3.9.0a0|&gt;~|=|3.5,~|&lt;|3.6.0a0|~|&lt;|4.0']
    requests~|=|~|=|2.24.0 ~|-|&gt; python
    pytorch::pytorch~|=|~|=|1.6.0 ~|-|&gt; ninja ~|-|&gt; python[version~|=|'2.7.|3.5.|3.6.|&gt;~|=|2.7,~|&lt;|2.8.0a0|&gt;~|=|3.5,~|&lt;|3.6.0a0|&gt;~|=|3.9,~|&lt;|3.10.0a0|3.4.']
    python~|=|~|=|3.6.11

    Package python_abi conflicts for:
    pytorch::pytorch~|=|~|=|1.6.0 ~|-|&gt; ninja ~|-|&gt; python_abi[version~|=|'3.6|3.6.|3.8.|3.7.|3.7|3.9.',build~|=|'_cp39|_cp37m|_pypy36_pp73|_cp36m|_cp38|_pypy37_pp73']
    click~|=|~|=|7.1.2 ~|-|&gt; python ~|-|&gt; python_abi[version~|=|'3.6|3.7',build~|=|'_pypy36_pp73|_pypy37_pp73']
    boto3~|=|~|=|1.14.47 ~|-|&gt; python ~|-|&gt; python_abi[version~|=|'3.6.|3.6|3.7|3.7.|3.8.|3.9.',build~|=|'_cp36m|_pypy36_pp73|_pypy37_pp73|_cp37m|_cp38|_cp39']
    requests~|=|~|=|2.24.0 ~|-|&gt; certifi[version~|=|'&gt;~|=|2017.4.17'] ~|-|&gt; python_abi[version~|=|'2.7.|3.6.|3.6|3.7|3.7.|3.9.|3.8.',build~|=|'_cp36m|_pypy36_pp73|_cp37m|_pypy37_pp73|_cp39|_cp38|_cp27mu']
    coverage~|=|~|=|4.5.4 ~|-|&gt; python[version~|=|'&gt;~|=|3.7,~|&lt;|3.8.0a0'] ~|-|&gt; python_abi[version~|=|'3.6|3.7',build~|=|'_pypy36_pp73|_pypy37_pp73']

    Package _openmp_mutex conflicts for:
    coverage~|=|~|=|4.5.4 ~|-|&gt; libgcc~|-|ng[version~|=|'&gt;~|=|7.3.0'] ~|-|&gt; _openmp_mutex[version~|=|'&gt;~|=|4.5']
    python~|=|~|=|3.6.11 ~|-|&gt; libgcc~|-|ng[version~|=|'&gt;~|=|9.3.0'] ~|-|&gt; _openmp_mutex[version~|=|'&gt;~|=|4.5']
    pytorch::pytorch~|=|~|=|1.6.0 ~|-|&gt; blas~|=|[build~|=|mkl] ~|-|&gt; _openmp_mutex[version~|=|'|&gt;~|=|4.5',build~|=|_llvm]
    anaconda::cudatoolkit~|=|~|=|11.0.221 ~|-|&gt; libgcc~|-|ng[version~|=|'&gt;~|=|7.3.0'] ~|-|&gt; _openmp_mutex[version~|=|'&gt;~|=|4.5']

    Package ca~|-|certificates conflicts for:
    coverage~|=|~|=|4.5.4 ~|-|&gt; python[version~|=|'&gt;~|=|2.7,~|&lt;|2.8.0a0'] ~|-|&gt; ca~|-|certificates
    click~|=|~|=|7.1.2 ~|-|&gt; python ~|-|&gt; ca~|-|certificates
    boto3~|=|~|=|1.14.47 ~|-|&gt; python ~|-|&gt; ca~|-|certificates
    python~|=|~|=|3.6.11 ~|-|&gt; openssl[version~|=|'&gt;~|=|1.1.1h,~|&lt;|1.1.2a'] ~|-|&gt; ca~|-|certificates
    requests~|=|~|=|2.24.0 ~|-|&gt; python ~|-|&gt; ca~|-|certificates
```

</details>

<h2 id="summary">Summary</h2>

<ol>
  <li>One uses pre-built images by
<a href="https://github.com/aws/deep-learning-containers/blob/master/available_images.md">Amazon Deep Learning Images</a>
project. However these images are quite large (10GB+).</li>
  <li>If one doesnt use an Amazon Deep Learning Image, he/she can leverage Metaflow(&gt;=2.2.8)
<code class="language-plaintext highlighter-rouge">@environment</code> decorator to set NVIDIA/CUDA environment variables to make GPU devices visible
to the code that uses it. A simple example is
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="o">@</span><span class="n">environment</span><span class="p">(</span>
     <span class="o">~|</span><span class="c1">#| environment decorator is used to set up global system level
</span>     <span class="o">~|</span><span class="c1">#| environment variables
</span>     <span class="nb">vars</span><span class="o">~|=|</span><span class="p">{</span>
         <span class="s">'NVIDIA_DRIVER_CAPABILITIES'</span><span class="p">:</span> <span class="s">'compute,utility'</span><span class="p">,</span>  <span class="o">~|</span><span class="c1">#| necessary to allow computation on GPUs
</span>         <span class="s">'CUDA_VISIBLE_DEVICES'</span><span class="p">:</span> <span class="s">'0,1'</span><span class="p">,</span>  <span class="o">~|</span><span class="c1">#| make two CUDA devices visible
</span>     <span class="p">}</span>
 <span class="p">)</span>
</code></pre></div>    </div>
  </li>
  <li>Manually setting up the above environment variables <strong>before importing torch</strong> also works
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="o">@</span><span class="n">step</span>
 <span class="k">def</span> <span class="nf">a_metaflow_step</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">os</span>
    <span class="o">~|</span><span class="c1">#| This trick is not only for Metaflow but for general Python scripts as well
</span>    <span class="o">~|</span><span class="c1">#| Make CUDA devices visible before import torch
</span>    <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">[</span><span class="s">'NVIDIA_DRIVER_CAPABILITIES'</span><span class="p">]</span> <span class="o">~|=|</span> <span class="s">'compute,utility'</span>
    <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">[</span><span class="s">'CUDA_VISIBLE_DEVICES'</span><span class="p">]</span> <span class="o">~|=|</span> <span class="s">'0,1'</span>
    <span class="kn">import</span> <span class="nn">torch</span>
</code></pre></div>    </div>
  </li>
  <li>NVIDIA drivers should naturally comes with the P-series EC2 instances if you have a correctly managed Metaflow compute environment</li>
  <li>Custom image, and manual installation of CUDA can be untrivial and results in version conflict.</li>
</ol>

<h3 id="related-issues-from-the-metaflow-community">Related Issues from the Metaflow Community</h3>

<ol>
  <li><a href="https://github.com/Netflix/metaflow/issues/250">Github Issue #250</a>: Documentation / Explanation on how to use GPU</li>
  <li>
    <p>Two related conversations in Gitter:</p>

    <p>https://gitter.im/metaflow_org/community?at=604a5b9dd71b6554cd390ffa
https://gitter.im/metaflow_org/community?at=6037f8d9cdbfc0620c2aedf2</p>
  </li>
</ol>


                <!-- Pagination links -->


            </article>

            

        </section>

        <!-- Add time bar only for pages without pagination -->
        

        <!-- Show modal if the post is the last one -->
        

        <!-- Show modal before user leaves the page -->
        

        <!-- Add your newsletter subscription form here -->

        <section class="share">
    <h3>Share</h3>
    <a aria-label="Share on Twitter" href="https://twitter.com/intent/tweet?text=&quot;GPU usage for deep learning is not trivial in Metaflow due to the fact that one needs to install CUDA in a correct way and expose the GPU hardwares to the container that runs Metaflow steps.&quot;%20/example-of-gpu-usage-in-metaflow/%20via%20&#64;zefrinc&hashtags=python,"
    onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;" title="Share on Twitter">
        <svg class="icon icon-twitter"><use xlink:href="#icon-twitter"></use></svg>
    </a>
    <a aria-label="Share on Facebook" href="https://www.facebook.com/sharer/sharer.php?u=/example-of-gpu-usage-in-metaflow/"
    onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;" title="Share on Facebook">
        <svg class="icon icon-facebook"><use xlink:href="#icon-facebook"></use></svg>
    </a>
</section>

        
  <section class="author">
    <div class="details">
      
      <img class="img-rounded" src="/blog-theme/assets/img/authors/kellygajewski.png" alt="Kelly Gajewski">
      
      <p class="def">Author</p>
      <h3 class="name">
        <a href="/authors/kellygajewski/">Kelly Gajewski</a>
      </h3>
      <p class="desc">Software Engineer II</p>
      <p>
        
        <a href="https://github.com/kellygajewski" title="Github">
          <svg>
            <use xlink:href="#icon-github"></use>
          </svg>
        </a>
        
        
        <a href="https://www.facebook.com/kellygajewski" title="Facebook">
          <svg>
            <use xlink:href="#icon-facebook"></use>
          </svg>
        </a>
        
        
        <a href="https://twitter.com/kellygajewski" title="Twitter">
          <svg>
            <use xlink:href="#icon-twitter"></use>
          </svg>
        </a>
        
        
        <a href="https://medium.com/@kellygajewski" title="Medium">
          <svg>
            <use xlink:href="#icon-medium"></use>
          </svg>
        </a>
        
        
        <a href="https://www.instagram.com/kellygajewski" title="Instagram">
          <svg>
            <use xlink:href="#icon-instagram"></use>
          </svg>
        </a>
        
        
        <a href="https://www.linkedin.com/in/kellygajewski" title="LinkedIn">
          <svg>
            <use xlink:href="#icon-linkedin"></use>
          </svg>
        </a>
        
      </p>
    </div>
  </section>

  <section class="author">
    <div class="details">
      
      <img class="img-rounded" src="/blog-theme/assets/img/authors/wesleytanner.jpeg" alt="Wesley Tanner">
      
      <p class="def">Author</p>
      <h3 class="name">
        <a href="/authors/wesleytanner/">Wesley Tanner</a>
      </h3>
      <p class="desc">Director Data Engineering</p>
      <p>
        
        <a href="https://github.com/wesleytanner" title="Github">
          <svg>
            <use xlink:href="#icon-github"></use>
          </svg>
        </a>
        
        
        <a href="https://www.facebook.com/wesleytanner" title="Facebook">
          <svg>
            <use xlink:href="#icon-facebook"></use>
          </svg>
        </a>
        
        
        <a href="https://twitter.com/wesleytanner" title="Twitter">
          <svg>
            <use xlink:href="#icon-twitter"></use>
          </svg>
        </a>
        
        
        <a href="https://medium.com/@wesleytanner" title="Medium">
          <svg>
            <use xlink:href="#icon-medium"></use>
          </svg>
        </a>
        
        
        <a href="https://www.instagram.com/wesleytanner" title="Instagram">
          <svg>
            <use xlink:href="#icon-instagram"></use>
          </svg>
        </a>
        
        
        <a href="https://www.linkedin.com/in/wesleytanner" title="LinkedIn">
          <svg>
            <use xlink:href="#icon-linkedin"></use>
          </svg>
        </a>
        
      </p>
    </div>
  </section>

  <section class="author">
    <div class="details">
      
      <img class="img-rounded" src="/blog-theme/assets/img/authors/zexuanzhou.jpeg" alt="Bruce Zhou">
      
      <p class="def">Author</p>
      <h3 class="name">
        <a href="/authors/zexuanzhou/">Bruce Zhou</a>
      </h3>
      <p class="desc">Senior Data Scientist</p>
      <p>
        
        <a href="https://github.com/zexuanzhou" title="Github">
          <svg>
            <use xlink:href="#icon-github"></use>
          </svg>
        </a>
        
        
        <a href="https://www.facebook.com/zexuanzhou" title="Facebook">
          <svg>
            <use xlink:href="#icon-facebook"></use>
          </svg>
        </a>
        
        
        <a href="https://twitter.com/zexuanzhou" title="Twitter">
          <svg>
            <use xlink:href="#icon-twitter"></use>
          </svg>
        </a>
        
        
        <a href="https://medium.com/@zexuanzhou" title="Medium">
          <svg>
            <use xlink:href="#icon-medium"></use>
          </svg>
        </a>
        
        
        <a href="https://www.instagram.com/zexuanzhou" title="Instagram">
          <svg>
            <use xlink:href="#icon-instagram"></use>
          </svg>
        </a>
        
        
        <a href="https://www.linkedin.com/in/zexuanzhou" title="LinkedIn">
          <svg>
            <use xlink:href="#icon-linkedin"></use>
          </svg>
        </a>
        
      </p>
    </div>
  </section>





  
  
  
  
  
  
  

  <script type="application/ld+json">
  {
      "@context": "http://schema.org",
      "@type": "Person",
      "name": "Kelly Gajewski",
      
      "image": "/blog-theme/assets/img/authors/kellygajewski.png",
      
      "jobTitle": "Chief Editor",
      "url": "/blog-theme/authors/kellygajewski/",
      "sameAs": [
        "https://github.com/kellygajewski","https://www.facebook.com/kellygajewski","https://twitter.com/kellygajewski","https://medium.com/@kellygajewski","https://www.instagram.com/kellygajewski","https://www.linkedin.com/in/kellygajewski"
      ]
  }
  </script>


        

        <footer>
    <p>
      
        <a href="https://github.com/ZEFR-INC" title="Github">
          <svg><use xlink:href="#icon-github"></use></svg>
        </a>
      
      
        <a href="https://www.facebook.com/ZEFRinc" title="Facebook">
          <svg><use xlink:href="#icon-facebook"></use></svg>
        </a>
      
      
        <a href="https://twitter.com/zefrinc" title="Twitter">
          <svg><use xlink:href="#icon-twitter"></use></svg>
        </a>
      
      
      
      
        <a href="https://www.linkedin.com/company/zefr" title="LinkedIn">
          <svg><use xlink:href="#icon-linkedin"></use></svg>
        </a>
      
    </p>

    <ul>
  
</ul>


    <!-- <p>
      <span>Jekflix</span> was made with <svg class="love"><use xlink:href="#icon-heart"></use></svg> by <a href="https://rossener.com" target="_blank" class="creator">Thiago Rossener</a>
    </p> -->
    <p>
      Technical, cultural, and philosophical musings by Zefr engineering
    </p>
</footer>









<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Organization",
  "name": "Zefr Engineering Blog",
  "description": "Technical, cultural, and philosophical musings by Zefr engineering",
  "url": "/blog-theme/",
  "logo": {
      "@type": "ImageObject",
      "url": "/blog-theme/blog-theme/assets/img/icons/mediumtile.png",
      "width": "600",
      "height": "315"
  },
  "sameAs": [
    "https://github.com/ZEFR-INC","https://www.facebook.com/ZEFRinc","https://twitter.com/zefrinc","https://www.linkedin.com/company/zefr"
  ]
}
</script>

<!-- Include the script that allows Netlify CMS login -->
<script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>

<!-- Include the website scripts -->
<script src="/blog-theme/assets/js/scripts.min.js"></script>

<!-- Include Google Analytics script -->
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-XXXXXXXX-X"></script>
<script>
  var host = window.location.hostname;
  if (host != 'localhost') {
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-XXXXXXXX-X');
  }
</script>
  


<!-- Include extra scripts -->



        

        
        
        
        
        
        
        
        
        <script type="application/ld+json">
        {
            "@context": "http://schema.org",
            "@type": "BlogPosting",
            "name": "Example of GPU usage in Metaflow",
            "headline": "",
            "description": "GPU usage for deep learning is not trivial in Metaflow due to the fact that one needs to install CUDA in a correct way and expose the GPU hardwares to the container that runs Metaflow steps.",
            "image": "/blog-theme/assets/img/posts/example-of-gpu-usage-in-metaflow/metaflow.jpg",
            "url": "/blog-theme/example-of-gpu-usage-in-metaflow/",
            "articleBody": "The test_metaflow_gpu.py contains an example of how to allocate
GPU resources and make use of it for deep learning in Metaflow.

GPU usage for deep learning is not trivial in Metaflow due to
the fact that one needs to install CUDA in a correct way and
expose the GPU hardwares to the container that runs Metaflow steps.

Core setup (in Metaflow) is to use the resource(gpu=N) decorator
for EC2 resources and the batch(..., image=IMAGE_WITH_CUDA) decorator
(or the use no image and set up CUDA/NVIDIA environment variables with
Metaflow(&amp;gt;=2.2.8)
@environment decorator) for AWS Batch resources

@batch(
    cpu~|=|2,
    gpu~|=|2,
    memory~|=|2400,
    ~|#| This image can work without the @environment decorator because NVIDIA and CUDA related environment
    ~|#| variables have been set up in the docker
    ~|#| image~|=|&quot;763104351884.dkr.ecr.us~|-|east~|-|1.amazonaws.com/pytorch~|-|training:1.7.1~|-|gpu~|-|py36~|-|cu110~|-|ubuntu18.04&quot;
)
@environment(
    ~|#| environment decorator is used to set up global system level
    ~|#| environment variables
    vars~|=|{
        &apos;NVIDIA_DRIVER_CAPABILITIES&apos;: &apos;compute,utility&apos;,  ~|#| necessary to allow computation on GPUs
        &apos;CUDA_VISIBLE_DEVICES&apos;: &apos;0,1&apos;,  ~|#| make two CUDA devices visible
    }
)
@conda(libraries~|=|{
    &apos;pytorch::pytorch&apos;: &apos;1.7.1&apos;,  ~|#| need this conda decorator to install pytorch.
    ~|#| Metaflow will not automatically recognize the pytorch installed in the above image
    ~|#| because it will create its own conda env
    ~|#| The first pytorch before &apos;::&apos; is the pytorch conda channel
    ~|#| One wants to install from that channel for CUDA support
    ~|#| The conda~|-|forge channel&apos;s pytorch doesn&apos;t come with CUDA support
})
def start(self):
    ...


The image 763104351884.dkr.ecr.us-east-1.amazonaws.com/pytorch-training:1.6.0-gpu-py36-cu110-ubuntu18.04 used above can be obtained from Amazon Deep Learning Images project. A variety of deep learning images with different types of deep learning frameworks (Tensorflow, Pytorch, etc), different CUDA versions (CUDA10, CUDA11) are provided.

How to run

USERNAME~|=|YOURUSERNAME CONDA_CHANNELS~|=|default,pytorch,conda~|-|forge METAFLOW_PROFILE~|=|ds~|-|dev AWS_PROFILE~|=|ds~|-|dev~|-|admin python test_metaflow_gpu.py ~|-|~|-|environment~|=|conda run


For how to setup the METAFLOW_PROFILE and AWS_PROFILE, refer to the local_dev folder.

Expected result should be


    Expected output (click to expand)

```shell
(base) root@2b15d8a4c149:/ds~|-|model~|-|mlm~|-|metaflow/tests/test_metaflow_gpu~|#| USERNAME~|=|bz CONDA_CHANNELS~|=|default,pytorch,conda~|-|forge METAFLOW_PROFILE~|=|ds~|-|dev AWS_PROFILE~|=|ds~|-|dev~|-|admin python test_metaflow_gpu.py ~|-|~|-|environment~|=|conda run
Metaflow 2.2.7 executing TestGPUFlow for user:bz
Validating your flow...
    The graph looks good!
Running pylint...
    Pylint is happy!
Bootstrapping conda environment...(this could take a few minutes)
2021~|-|03~|-|12 04:51:56.446 Workflow starting (run~|-|id 129):
2021~|-|03~|-|12 04:52:00.209 [129/start/1341 (pid 5161)] Task is starting.
2021~|-|03~|-|12 04:52:02.427 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] Task is starting (status SUBMITTED)...
2021~|-|03~|-|12 04:52:04.723 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] Task is starting (status RUNNABLE)...
2021~|-|03~|-|12 04:52:34.796 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] Task is starting (status RUNNABLE)...
2021~|-|03~|-|12 04:53:04.927 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] Task is starting (status RUNNABLE)...
2021~|-|03~|-|12 04:53:35.036 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] Task is starting (status RUNNABLE)...
2021~|-|03~|-|12 04:54:05.230 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] Task is starting (status RUNNABLE)...
2021~|-|03~|-|12 04:54:35.386 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] Task is starting (status RUNNABLE)...
2021~|-|03~|-|12 04:54:45.615 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] Task is starting (status STARTING)...
2021~|-|03~|-|12 04:55:15.622 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] Task is starting (status STARTING)...
2021~|-|03~|-|12 04:55:45.627 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] Task is starting (status STARTING)...
2021~|-|03~|-|12 04:56:15.788 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] Task is starting (status STARTING)...
2021~|-|03~|-|12 04:56:45.927 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] Task is starting (status STARTING)...
2021~|-|03~|-|12 04:57:16.127 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] Task is starting (status STARTING)...
2021~|-|03~|-|12 04:57:46.147 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] Task is starting (status STARTING)...
2021~|-|03~|-|12 04:58:15.881 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] Task is starting (status RUNNING)...
2021~|-|03~|-|12 04:58:20.154 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] bash: cannot set terminal process group (~|-|1): Inappropriate ioctl for device
2021~|-|03~|-|12 04:58:20.155 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] bash: no job control in this shell
2021~|-|03~|-|12 04:58:20.156 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] AWS_BATCH_CE_NAME~|=|&apos;MetaflowComputeEnvironment&apos;
2021~|-|03~|-|12 04:58:20.156 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] AWS_BATCH_JOB_ATTEMPT~|=|&apos;1&apos;
2021~|-|03~|-|12 04:58:20.157 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] AWS_BATCH_JOB_ID~|=|&apos;931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226&apos;
2021~|-|03~|-|12 04:58:20.158 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] AWS_BATCH_JQ_NAME~|=|&apos;job~|-|queue~|-|metaflow~|-|infrastructure&apos;
2021~|-|03~|-|12 04:58:20.158 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] AWS_CONTAINER_CREDENTIALS_RELATIVE_URI~|=|&apos;/v2/credentials/0a3ac1ce~|-|0a34~|-|41bc~|-|a916~|-|e2cf51a907c0&apos;
2021~|-|03~|-|12 04:58:20.159 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] AWS_DEFAULT_REGION~|=|&apos;us~|-|east~|-|1&apos;
2021~|-|03~|-|12 04:58:20.160 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] AWS_EXECUTION_ENV~|=|&apos;AWS_ECS_EC2&apos;
2021~|-|03~|-|12 04:58:20.160 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] CMAKE_PREFIX_PATH~|=|&apos;$(dirname $(which conda))/../&apos;
2021~|-|03~|-|12 04:58:20.161 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] CUDA_VERSION~|=|&apos;11.0.3&apos;
2021~|-|03~|-|12 04:58:20.161 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] CUDNN_VERSION~|=|&apos;8.0.4.30&apos;
2021~|-|03~|-|12 04:58:20.162 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] DGLBACKEND~|=|&apos;pytorch&apos;
2021~|-|03~|-|12 04:58:20.162 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] ECS_CONTAINER_METADATA_URI~|=|&apos;http://169.254.170.2/v3/615eaa62~|-|7e66~|-|46b8~|-|9b7f~|-|feafa2874358&apos;
2021~|-|03~|-|12 04:58:20.162 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] ECS_CONTAINER_METADATA_URI_V4~|=|&apos;http://169.254.170.2/v4/615eaa62~|-|7e66~|-|46b8~|-|9b7f~|-|feafa2874358&apos;
2021~|-|03~|-|12 04:58:20.163 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] HOME~|=|&apos;/root&apos;
2021~|-|03~|-|12 04:58:20.163 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] HOROVOD_VERSION~|=|&apos;0.20.3&apos;
2021~|-|03~|-|12 04:58:20.164 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] HOSTNAME~|=|&apos;ip~|-|10~|-|13~|-|90~|-|128.ec2.internal&apos;
2021~|-|03~|-|12 04:58:20.164 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] IFS~|=|&apos;
2021~|-|03~|-|12 04:58:20.165 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] &apos;
2021~|-|03~|-|12 04:58:22.935 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] LANG~|=|&apos;C.UTF~|-|8&apos;
2021~|-|03~|-|12 04:58:22.936 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] LC_ALL~|=|&apos;C.UTF~|-|8&apos;
2021~|-|03~|-|12 04:58:22.937 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] LD_LIBRARY_PATH~|=|&apos;/opt/conda/lib/python3.6/site~|-|packages/smdistributed/dataparallel/lib:/home/.openmpi/lib/:/opt/conda/lib:/usr/local/lib:/usr/local/nvidia/lib:/usr/local/nvidia/lib64&apos;
2021~|-|03~|-|12 04:58:22.938 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] LIBRARY_PATH~|=|&apos;/usr/local/cuda/lib64/stubs&apos;
2021~|-|03~|-|12 04:58:22.939 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] MANUAL_BUILD~|=|&apos;0&apos;
2021~|-|03~|-|12 04:58:22.940 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] METAFLOW_CODE_DS~|=|&apos;s3&apos;
2021~|-|03~|-|12 04:58:22.940 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] METAFLOW_CODE_SHA~|=|&apos;0cade183b6e658b8d9b0343997eace8b235334cf&apos;
2021~|-|03~|-|12 04:58:22.941 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] METAFLOW_CODE_URL~|=|&apos;s3://zefr~|-|ds~|-|dev~|-|use1~|-|865426939207~|-|s3~|-|metaflow/metaflow/TestGPUFlow/data/0c/0cade183b6e658b8d9b0343997eace8b235334cf&apos;
2021~|-|03~|-|12 04:58:22.942 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] METAFLOW_DATASTORE_SYSROOT_S3~|=|&apos;s3://zefr~|-|ds~|-|dev~|-|use1~|-|865426939207~|-|s3~|-|metaflow/metaflow&apos;
2021~|-|03~|-|12 04:58:22.943 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] METAFLOW_DATATOOLS_S3ROOT~|=|&apos;s3://zefr~|-|ds~|-|dev~|-|use1~|-|865426939207~|-|s3~|-|metaflow/metaflow/data&apos;
2021~|-|03~|-|12 04:58:22.944 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] METAFLOW_DEFAULT_DATASTORE~|=|&apos;s3&apos;
2021~|-|03~|-|12 04:58:22.944 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] METAFLOW_DEFAULT_METADATA~|=|&apos;service&apos;
2021~|-|03~|-|12 04:58:22.945 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] METAFLOW_INPUT_PATHS_0~|=|&apos;129/_parameters/1340&apos;
2021~|-|03~|-|12 04:58:22.946 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] METAFLOW_SERVICE_HEADERS~|=|&apos;{}&apos;
2021~|-|03~|-|12 04:58:22.948 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] METAFLOW_SERVICE_URL~|=|&apos;http://tf~|-|lb~|-|20210225192300834700000001~|-|bb0309f275885bf4.elb.us~|-|east~|-|1.amazonaws.com/&apos;
2021~|-|03~|-|12 04:58:22.949 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] METAFLOW_USER~|=|&apos;bz&apos;
2021~|-|03~|-|12 04:58:22.950 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] NCCL_VERSION~|=|&apos;2.7.8&apos;
2021~|-|03~|-|12 04:58:22.951 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] NVIDIA_DRIVER_CAPABILITIES~|=|&apos;compute,utility&apos;
2021~|-|03~|-|12 04:58:22.951 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] NVIDIA_REQUIRE_CUDA~|=|&apos;cuda&amp;gt;~|=|11.0 brand~|=|tesla,driver&amp;gt;~|=|418,driver~|&amp;lt;|419 brand~|=|tesla,driver&amp;gt;~|=|440,driver~|&amp;lt;|441 brand~|=|tesla,driver&amp;gt;~|=|450,driver~|&amp;lt;|451&apos;
2021~|-|03~|-|12 04:58:22.952 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] NVIDIA_VISIBLE_DEVICES~|=|&apos;GPU~|-|4d88dac3~|-|b808~|-|8c02~|-|30cb~|-|817671287688&apos;
2021~|-|03~|-|12 04:58:22.953 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] OPTIND~|=|&apos;1&apos;
2021~|-|03~|-|12 04:58:22.955 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] PATH~|=|&apos;/home/.openmpi/bin:/opt/conda/bin:/usr/local/nvidia/bin:/usr/local/cuda/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin&apos;
2021~|-|03~|-|12 04:58:22.955 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] PPID~|=|&apos;1&apos;
2021~|-|03~|-|12 04:58:22.956 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] PS1~|=|&apos;~|#| &apos;
2021~|-|03~|-|12 04:58:22.958 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] PS2~|=|&apos;&amp;gt; &apos;
2021~|-|03~|-|12 04:58:22.958 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] PS4~|=|&apos;+ &apos;
2021~|-|03~|-|12 04:58:22.960 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] PWD~|=|&apos;/&apos;
2021~|-|03~|-|12 04:58:22.960 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] PYTHONDONTWRITEBYTECODE~|=|&apos;1&apos;
2021~|-|03~|-|12 04:58:22.961 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] PYTHONIOENCODING~|=|&apos;UTF~|-|8&apos;
2021~|-|03~|-|12 04:58:22.962 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] PYTHONUNBUFFERED~|=|&apos;1&apos;
2021~|-|03~|-|12 04:58:22.963 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] SAGEMAKER_TRAINING_MODULE~|=|&apos;sagemaker_pytorch_container.training:main&apos;
2021~|-|03~|-|12 04:58:22.964 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] SHLVL~|=|&apos;1&apos;
2021~|-|03~|-|12 04:58:22.965 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] TORCH_CUDA_ARCH_LIST~|=|&apos;3.5 3.7 5.2 6.0 6.1 7.0+PTX 8.0&apos;
2021~|-|03~|-|12 04:58:22.966 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] TORCH_NVCC_FLAGS~|=|&apos;~|-|Xfatbin ~|-|compress~|-|all&apos;
2021~|-|03~|-|12 04:58:22.967 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] _~|=|&apos;/bin/sh&apos;
2021~|-|03~|-|12 04:58:22.968 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] Setting up task environment.
2021~|-|03~|-|12 04:58:22.970 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] Downloading code package.
2021~|-|03~|-|12 04:58:22.970 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] Code package downloaded.
2021~|-|03~|-|12 05:02:12.929 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] Bootstrapping environment.
2021~|-|03~|-|12 05:02:12.929 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] Environment bootstrapped.
2021~|-|03~|-|12 05:02:18.122 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] Task is starting.
2021~|-|03~|-|12 05:02:18.122 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] Fri Mar 12 05:02:15 2021
2021~|-|03~|-|12 05:02:18.122 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] +~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|+
2021~|-|03~|-|12 05:02:18.123 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] | NVIDIA~|-|SMI 450.51.06    Driver Version: 450.51.06    CUDA Version: 11.0     |
2021~|-|03~|-|12 05:02:18.123 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] |~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|+~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|+~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|+
2021~|-|03~|-|12 05:02:18.123 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] | GPU  Name        Persistence~|-|M| Bus~|-|Id        Disp.A | Volatile Uncorr. ECC |
2021~|-|03~|-|12 05:02:18.124 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] | Fan  Temp  Perf  Pwr:Usage/Cap|         Memory~|-|Usage | GPU~|-|Util  Compute M. |
2021~|-|03~|-|12 05:02:18.124 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] |                               |                      |               MIG M. |
2021~|-|03~|-|12 05:02:18.124 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] |~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|+~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|+~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=||
2021~|-|03~|-|12 05:02:18.125 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] |   0  Tesla V100~|-|SXM2...  Off  | 00000000:00:1E.0 Off |                    0 |
2021~|-|03~|-|12 05:02:18.125 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] | N/A   35C    P0    39W / 300W |      0MiB / 16160MiB |      0%      Default |
2021~|-|03~|-|12 05:02:18.125 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] |                               |                      |                  N/A |
2021~|-|03~|-|12 05:02:18.125 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] +~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|+~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|+~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|+
2021~|-|03~|-|12 05:02:18.126 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226]
2021~|-|03~|-|12 05:02:19.480 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] +~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|+
2021~|-|03~|-|12 05:02:19.480 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] | Processes:                                                                  |
2021~|-|03~|-|12 05:02:19.480 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] |  GPU   GI   CI        PID   Type   Process name                  GPU Memory |
2021~|-|03~|-|12 05:02:19.481 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] |        ID   ID                                                   Usage      |
2021~|-|03~|-|12 05:02:19.481 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] |~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=|~|=||
2021~|-|03~|-|12 05:02:19.481 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] |  No running processes found                                                 |
2021~|-|03~|-|12 05:02:19.481 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] +~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|~|-|+
2021~|-|03~|-|12 05:02:19.481 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] nvcc: NVIDIA (R) Cuda compiler driver
2021~|-|03~|-|12 05:02:19.481 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] Copyright (c) 2005~|-|2020 NVIDIA Corporation
2021~|-|03~|-|12 05:02:19.482 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] Built on Wed_Jul_22_19:09:09_PDT_2020
2021~|-|03~|-|12 05:02:19.482 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] Cuda compilation tools, release 11.0, V11.0.221
2021~|-|03~|-|12 05:02:19.482 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] Build cuda_11.0_bu.TC445_37.28845127_0
2021~|-|03~|-|12 05:02:19.482 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] __Python VERSION: 3.6.11 | packaged by conda~|-|forge | (default, Nov 27 2020, 18:57:37)
2021~|-|03~|-|12 05:02:19.482 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] [GCC 9.3.0]
2021~|-|03~|-|12 05:02:19.482 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] __pyTorch VERSION: 1.6.0
2021~|-|03~|-|12 05:02:19.482 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] __CUDA VERSION 10.2
2021~|-|03~|-|12 05:02:19.483 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] __CUDNN VERSION: 7605
2021~|-|03~|-|12 05:02:19.483 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] __Number CUDA Devices: 1
2021~|-|03~|-|12 05:02:21.931 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] __Devices
2021~|-|03~|-|12 05:02:21.931 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] index, name, driver_version, memory.total [MiB], memory.used [MiB], memory.free [MiB]
2021~|-|03~|-|12 05:02:21.932 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] 0, Tesla V100~|-|SXM2~|-|16GB, 450.51.06, 16160 MiB, 2 MiB, 16158 MiB
2021~|-|03~|-|12 05:02:21.932 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] Active CUDA Device: GPU 0
2021~|-|03~|-|12 05:02:21.932 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] Available devices  1
2021~|-|03~|-|12 05:02:21.932 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] Current cuda device  0
2021~|-|03~|-|12 05:02:21.932 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] GPU count: 1
2021~|-|03~|-|12 05:02:21.932 [129/start/1341 (pid 5161)] [931bbcf6~|-|5fa2~|-|4661~|-|83df~|-|1d82d52b6226] Task finished with exit code 0.
2021~|-|03~|-|12 05:02:25.812 [129/start/1341 (pid 5161)] Task finished successfully.
2021~|-|03~|-|12 05:02:28.636 [129/end/1342 (pid 5193)] Task is starting.
2021~|-|03~|-|12 05:02:39.328 [129/end/1342 (pid 5193)] Task finished successfully.
2021~|-|03~|-|12 05:02:39.766 Done!
```



Some key information to check from the above output is


How does it work?
NVIDIA Driver

The NVIDIA-SMI (represents the installation of NVIDIA driver) is obtained at EC2 instance level. Metaflow automatically picks an AMI with NVIDIA driver installed for your batch job when you request resources(gpu=N). Note that this WILL NOT happen if you dont have P2 or P3 instances in your Metaflow compute environment

How to check P-series instances? Simply look at your compute environment


CUDA Toolkit

This should come with the image used. The example image above 763104351884.dkr.ecr.us-east-1.amazonaws.com/pytorch-training:1.6.0-gpu-py36-cu110-ubuntu18.04 has CUDA installed.

Failed Example

If one wants to install CUDA through the @conda decorator in Metaflow, it sometimes CAN FAIL. To try, one can replace the decorator in the test_gpu_script_output.py with the following

&quot;&quot;&quot;This will fail due to conflict version&quot;&quot;&quot;

@batch(
    cpu~|=|2,
    gpu~|=|1,
    memory~|=|2400,
    image~|=|&quot;763104351884.dkr.ecr.us~|-|east~|-|1.amazonaws.com/pytorch~|-|training:1.6.0~|-|gpu~|-|py36~|-|cu110~|-|ubuntu18.04&quot;
)
@conda(libraries~|=|{
    &apos;pytorch::pytorch&apos;: &apos;1.6.0&apos;,  ~|#| need this conda decorator to install pytorch.
    ~|#| Metaflow will not automatically recognize the pytorch installed in the above image
    ~|#| because it will create its own conda env
    ~|#| The first pytorch before &apos;::&apos; is the pytorch conda channel
    ~|#| One wants to install from that channel for GPU support
    ~|#| The conda~|-|forge channel&apos;s pytorch doesn&apos;t come with GPU support
    &apos;anaconda::cudatoolkit&apos;: &apos;11.0.221&apos;
    ~|#| To find cudatoolkit version. Use `conda search cudatoolkit ~|-|c pytorch ~|-|c conda~|-|forge ~|-|c anaconda
})
@step
def start(self):
    ...


Expected output should be


    Expected output (click to expand)

```shell
(base) root@2b15d8a4c149:/ds~|-|model~|-|mlm~|-|metaflow/tests/test_metaflow_gpu~|#| USERNAME~|=|bz CONDA_CHANNELS~|=|default,pytorch,conda~|-|forge METAFLOW_PROFILE~|=|ds~|-|dev AWS_PROFILE~|=|ds~|-|dev~|-|admin python test_metaflow_gpu.py ~|-|~|-|environment~|=|conda run
Metaflow 2.2.7 executing TestGPUFlow for user:bz
Validating your flow...
    The graph looks good!
Running pylint...
    Pylint is happy!
Bootstrapping conda environment...(this could take a few minutes)
    Conda ran into an error while setting up environment.:
    Step: start, Error: UnsatisfiableError: The following specifications were found to be incompatible with each other:

    Output in format: Requested package ~|-|&amp;gt; Available versions

    Package libstdcxx~|-|ng conflicts for:
    python~|=|~|=|3.6.11 ~|-|&amp;gt; libstdcxx~|-|ng[version~|=|&apos;&amp;gt;~|=|7.5.0|&amp;gt;~|=|9.3.0&apos;]
    python~|=|~|=|3.6.11 ~|-|&amp;gt; libffi[version~|=|&apos;&amp;gt;~|=|3.3,~|&amp;lt;|3.4.0a0&apos;] ~|-|&amp;gt; libstdcxx~|-|ng[version~|=|&apos;7.2.0.|&amp;gt;~|=|4.9|&amp;gt;~|=|7.3.0|&amp;gt;~|=|7.2.0&apos;]

    Package cudatoolkit conflicts for:
    pytorch::pytorch~|=|~|=|1.6.0 ~|-|&amp;gt; cudatoolkit[version~|=|&apos;&amp;gt;~|=|10.1,~|&amp;lt;|10.2|&amp;gt;~|=|10.2,~|&amp;lt;|10.3|&amp;gt;~|=|9.2,~|&amp;lt;|9.3&apos;]
    anaconda|anaconda::cudatoolkit~|=|~|=|11.0.221
    anaconda::cudatoolkit~|=|~|=|11.0.221

    Package libgcc~|-|ng conflicts for:
    python~|=|~|=|3.6.11 ~|-|&amp;gt; libffi[version~|=|&apos;&amp;gt;~|=|3.3,~|&amp;lt;|3.4.0a0&apos;] ~|-|&amp;gt; libgcc~|-|ng[version~|=|&apos;7.2.0.|&amp;gt;~|=|4.9|&amp;gt;~|=|7.3.0|&amp;gt;~|=|7.2.0&apos;]
    coverage~|=|~|=|4.5.4 ~|-|&amp;gt; libgcc~|-|ng[version~|=|&apos;&amp;gt;~|=|7.3.0&apos;]
    pytorch::pytorch~|=|~|=|1.6.0 ~|-|&amp;gt; blas~|=|[build~|=|mkl] ~|-|&amp;gt; libgcc~|-|ng[version~|=|&apos;7.2.0.|&amp;gt;~|=|4.9|&amp;gt;~|=|7.2.0|&amp;gt;~|=|7.3.0|&amp;gt;~|=|7.5.0|&amp;gt;~|=|9.3.0&apos;]
    anaconda::cudatoolkit~|=|~|=|11.0.221 ~|-|&amp;gt; libgcc~|-|ng[version~|=|&apos;&amp;gt;~|=|7.3.0&apos;]
    requests~|=|~|=|2.24.0 ~|-|&amp;gt; python ~|-|&amp;gt; libgcc~|-|ng[version~|=|&apos;7.2.0.|&amp;gt;~|=|4.9|&amp;gt;~|=|7.3.0|&amp;gt;~|=|7.5.0|&amp;gt;~|=|9.3.0|&amp;gt;~|=|7.2.0&apos;]
    boto3~|=|~|=|1.14.47 ~|-|&amp;gt; python ~|-|&amp;gt; libgcc~|-|ng[version~|=|&apos;7.2.0.|&amp;gt;~|=|4.9|&amp;gt;~|=|7.3.0|&amp;gt;~|=|7.5.0|&amp;gt;~|=|9.3.0|&amp;gt;~|=|7.2.0&apos;]
    python~|=|~|=|3.6.11 ~|-|&amp;gt; libgcc~|-|ng[version~|=|&apos;&amp;gt;~|=|7.5.0|&amp;gt;~|=|9.3.0&apos;]
    click~|=|~|=|7.1.2 ~|-|&amp;gt; python ~|-|&amp;gt; libgcc~|-|ng[version~|=|&apos;7.2.0.|&amp;gt;~|=|4.9|&amp;gt;~|=|7.3.0|&amp;gt;~|=|7.5.0|&amp;gt;~|=|9.3.0|&amp;gt;~|=|7.2.0&apos;]
    coverage~|=|~|=|4.5.4 ~|-|&amp;gt; python[version~|=|&apos;&amp;gt;~|=|3.8,~|&amp;lt;|3.9.0a0&apos;] ~|-|&amp;gt; libgcc~|-|ng[version~|=|&apos;7.2.0.|&amp;gt;~|=|4.9|&amp;gt;~|=|7.5.0|&amp;gt;~|=|9.3.0|&amp;gt;~|=|7.2.0&apos;]

    Package _libgcc_mutex conflicts for:
    anaconda::cudatoolkit~|=|~|=|11.0.221 ~|-|&amp;gt; libgcc~|-|ng[version~|=|&apos;&amp;gt;~|=|7.3.0&apos;] ~|-|&amp;gt; _libgcc_mutex[version~|=|&apos;|0.1&apos;,build~|=|&apos;conda_forge|main&apos;]
    coverage~|=|~|=|4.5.4 ~|-|&amp;gt; libgcc~|-|ng[version~|=|&apos;&amp;gt;~|=|7.3.0&apos;] ~|-|&amp;gt; _libgcc_mutex[version~|=|&apos;|0.1&apos;,build~|=|&apos;conda_forge|main&apos;]
    python~|=|~|=|3.6.11 ~|-|&amp;gt; libgcc~|-|ng[version~|=|&apos;&amp;gt;~|=|9.3.0&apos;] ~|-|&amp;gt; _libgcc_mutex[version~|=|&apos;|0.1&apos;,build~|=|&apos;conda_forge|main&apos;]

    Package tzdata conflicts for:
    click~|=|~|=|7.1.2 ~|-|&amp;gt; python ~|-|&amp;gt; tzdata
    boto3~|=|~|=|1.14.47 ~|-|&amp;gt; python ~|-|&amp;gt; tzdata
    requests~|=|~|=|2.24.0 ~|-|&amp;gt; python ~|-|&amp;gt; tzdata

    Package urllib3 conflicts for:
    boto3~|=|~|=|1.14.47 ~|-|&amp;gt; botocore[version~|=|&apos;&amp;gt;~|=|1.17.47,~|&amp;lt;|1.18.0&apos;] ~|-|&amp;gt; urllib3[version~|=|&apos;&amp;gt;~|=|1.20,~|&amp;lt;|1.26&apos;]
    requests~|=|~|=|2.24.0 ~|-|&amp;gt; urllib3[version~|=|&apos;&amp;gt;~|=|1.21.1,~|&amp;lt;|1.26,!~|=|1.25.0,!~|=|1.25.1&apos;]

    Package python conflicts for:
    click~|=|~|=|7.1.2 ~|-|&amp;gt; python
    boto3~|=|~|=|1.14.47 ~|-|&amp;gt; python
    pytorch::pytorch~|=|~|=|1.6.0 ~|-|&amp;gt; python[version~|=|&apos;&amp;gt;~|=|3.6,~|&amp;lt;|3.7.0a0|&amp;gt;~|=|3.7,~|&amp;lt;|3.8.0a0|&amp;gt;~|=|3.8,~|&amp;lt;|3.9.0a0&apos;]
    coverage~|=|~|=|4.5.4 ~|-|&amp;gt; python[version~|=|&apos;&amp;gt;~|=|2.7,~|&amp;lt;|2.8.0a0|&amp;gt;~|=|3.6,~|&amp;lt;|3.7.0a0|&amp;gt;~|=|3.7,~|&amp;lt;|3.8.0a0|&amp;gt;~|=|3.8,~|&amp;lt;|3.9.0a0&apos;]
    boto3~|=|~|=|1.14.47 ~|-|&amp;gt; jmespath[version~|=|&apos;&amp;gt;~|=|0.7.1,~|&amp;lt;|1.0.0&apos;] ~|-|&amp;gt; python[version~|=|&apos;2.7.|3.5.|3.6.|3.4.|&amp;gt;~|=|3.5,~|&amp;lt;|3.6.0a0|&amp;gt;~|=|3.7,~|&amp;lt;|3.8.0a0|&amp;gt;~|=|2.7,~|&amp;lt;|2.8.0a0|&amp;gt;~|=|3.6,~|&amp;lt;|3.7.0a0|&amp;gt;~|=|3|&amp;gt;~|=|3.8,~|&amp;lt;|3.9.0a0|&amp;gt;~|=|3.9,~|&amp;lt;|3.10.0a0&apos;]
    requests~|=|~|=|2.24.0 ~|-|&amp;gt; certifi[version~|=|&apos;&amp;gt;~|=|2017.4.17&apos;] ~|-|&amp;gt; python[version~|=|&apos;2.7.|3.5.|3.6.|&amp;gt;~|=|2.7,~|&amp;lt;|2.8.0a0|&amp;gt;~|=|3.6,~|&amp;lt;|3.7.0a0|&amp;gt;~|=|3.7,~|&amp;lt;|3.8.0a0|&amp;gt;~|=|3.9,~|&amp;lt;|3.10.0a0|&amp;gt;~|=|3.8,~|&amp;lt;|3.9.0a0|&amp;gt;~|=|3.5,~|&amp;lt;|3.6.0a0|~|&amp;lt;|4.0&apos;]
    requests~|=|~|=|2.24.0 ~|-|&amp;gt; python
    pytorch::pytorch~|=|~|=|1.6.0 ~|-|&amp;gt; ninja ~|-|&amp;gt; python[version~|=|&apos;2.7.|3.5.|3.6.|&amp;gt;~|=|2.7,~|&amp;lt;|2.8.0a0|&amp;gt;~|=|3.5,~|&amp;lt;|3.6.0a0|&amp;gt;~|=|3.9,~|&amp;lt;|3.10.0a0|3.4.&apos;]
    python~|=|~|=|3.6.11

    Package python_abi conflicts for:
    pytorch::pytorch~|=|~|=|1.6.0 ~|-|&amp;gt; ninja ~|-|&amp;gt; python_abi[version~|=|&apos;3.6|3.6.|3.8.|3.7.|3.7|3.9.&apos;,build~|=|&apos;_cp39|_cp37m|_pypy36_pp73|_cp36m|_cp38|_pypy37_pp73&apos;]
    click~|=|~|=|7.1.2 ~|-|&amp;gt; python ~|-|&amp;gt; python_abi[version~|=|&apos;3.6|3.7&apos;,build~|=|&apos;_pypy36_pp73|_pypy37_pp73&apos;]
    boto3~|=|~|=|1.14.47 ~|-|&amp;gt; python ~|-|&amp;gt; python_abi[version~|=|&apos;3.6.|3.6|3.7|3.7.|3.8.|3.9.&apos;,build~|=|&apos;_cp36m|_pypy36_pp73|_pypy37_pp73|_cp37m|_cp38|_cp39&apos;]
    requests~|=|~|=|2.24.0 ~|-|&amp;gt; certifi[version~|=|&apos;&amp;gt;~|=|2017.4.17&apos;] ~|-|&amp;gt; python_abi[version~|=|&apos;2.7.|3.6.|3.6|3.7|3.7.|3.9.|3.8.&apos;,build~|=|&apos;_cp36m|_pypy36_pp73|_cp37m|_pypy37_pp73|_cp39|_cp38|_cp27mu&apos;]
    coverage~|=|~|=|4.5.4 ~|-|&amp;gt; python[version~|=|&apos;&amp;gt;~|=|3.7,~|&amp;lt;|3.8.0a0&apos;] ~|-|&amp;gt; python_abi[version~|=|&apos;3.6|3.7&apos;,build~|=|&apos;_pypy36_pp73|_pypy37_pp73&apos;]

    Package _openmp_mutex conflicts for:
    coverage~|=|~|=|4.5.4 ~|-|&amp;gt; libgcc~|-|ng[version~|=|&apos;&amp;gt;~|=|7.3.0&apos;] ~|-|&amp;gt; _openmp_mutex[version~|=|&apos;&amp;gt;~|=|4.5&apos;]
    python~|=|~|=|3.6.11 ~|-|&amp;gt; libgcc~|-|ng[version~|=|&apos;&amp;gt;~|=|9.3.0&apos;] ~|-|&amp;gt; _openmp_mutex[version~|=|&apos;&amp;gt;~|=|4.5&apos;]
    pytorch::pytorch~|=|~|=|1.6.0 ~|-|&amp;gt; blas~|=|[build~|=|mkl] ~|-|&amp;gt; _openmp_mutex[version~|=|&apos;|&amp;gt;~|=|4.5&apos;,build~|=|_llvm]
    anaconda::cudatoolkit~|=|~|=|11.0.221 ~|-|&amp;gt; libgcc~|-|ng[version~|=|&apos;&amp;gt;~|=|7.3.0&apos;] ~|-|&amp;gt; _openmp_mutex[version~|=|&apos;&amp;gt;~|=|4.5&apos;]

    Package ca~|-|certificates conflicts for:
    coverage~|=|~|=|4.5.4 ~|-|&amp;gt; python[version~|=|&apos;&amp;gt;~|=|2.7,~|&amp;lt;|2.8.0a0&apos;] ~|-|&amp;gt; ca~|-|certificates
    click~|=|~|=|7.1.2 ~|-|&amp;gt; python ~|-|&amp;gt; ca~|-|certificates
    boto3~|=|~|=|1.14.47 ~|-|&amp;gt; python ~|-|&amp;gt; ca~|-|certificates
    python~|=|~|=|3.6.11 ~|-|&amp;gt; openssl[version~|=|&apos;&amp;gt;~|=|1.1.1h,~|&amp;lt;|1.1.2a&apos;] ~|-|&amp;gt; ca~|-|certificates
    requests~|=|~|=|2.24.0 ~|-|&amp;gt; python ~|-|&amp;gt; ca~|-|certificates
```



Summary


  One uses pre-built images by
Amazon Deep Learning Images
project. However these images are quite large (10GB+).
  If one doesnt use an Amazon Deep Learning Image, he/she can leverage Metaflow(&amp;gt;=2.2.8)
@environment decorator to set NVIDIA/CUDA environment variables to make GPU devices visible
to the code that uses it. A simple example is
     @environment(
     ~|#| environment decorator is used to set up global system level
     ~|#| environment variables
     vars~|=|{
         &apos;NVIDIA_DRIVER_CAPABILITIES&apos;: &apos;compute,utility&apos;,  ~|#| necessary to allow computation on GPUs
         &apos;CUDA_VISIBLE_DEVICES&apos;: &apos;0,1&apos;,  ~|#| make two CUDA devices visible
     }
 )
    
  
  Manually setting up the above environment variables before importing torch also works
     @step
 def a_metaflow_step(self):
    import os
    ~|#| This trick is not only for Metaflow but for general Python scripts as well
    ~|#| Make CUDA devices visible before import torch
    os.environ[&apos;NVIDIA_DRIVER_CAPABILITIES&apos;] ~|=| &apos;compute,utility&apos;
    os.environ[&apos;CUDA_VISIBLE_DEVICES&apos;] ~|=| &apos;0,1&apos;
    import torch
    
  
  NVIDIA drivers should naturally comes with the P-series EC2 instances if you have a correctly managed Metaflow compute environment
  Custom image, and manual installation of CUDA can be untrivial and results in version conflict.


Related Issues from the Metaflow Community


  Github Issue #250: Documentation / Explanation on how to use GPU
  
    Two related conversations in Gitter:

    https://gitter.im/metaflow_org/community?at=604a5b9dd71b6554cd390ffa
https://gitter.im/metaflow_org/community?at=6037f8d9cdbfc0620c2aedf2
  

",
            "wordcount": "2473",
            "inLanguage": "en",
            "dateCreated": "2020-07-21/",
            "datePublished": "2020-07-21/",
            "dateModified": "2020-07-21/",
            "author": {
                "@type": "Person",
                "name": "Kelly Gajewski",
                
                "image": "/blog-theme/assets/img/authors/kellygajewski.png",
                
                "jobTitle": "Chief Editor",
                "url": "/blog-theme/authors/kellygajewski/",
                "sameAs": [
                    "https://github.com/kellygajewski","https://www.facebook.com/kellygajewski","https://twitter.com/kellygajewski","https://medium.com/@kellygajewski","https://www.instagram.com/kellygajewski","https://www.linkedin.com/in/kellygajewski"
                ]
            },
            "publisher": {
                "@type": "Organization",
                "name": "Zefr Engineering Blog",
                "url": "/blog-theme/",
                "logo": {
                    "@type": "ImageObject",
                    "url": "/blog-theme/blog-theme/assets/img/blog-image.png",
                    "width": "600",
                    "height": "315"
                }
            },
            "mainEntityOfPage": "True",
            "genre": "life",
            "articleSection": "life",
            "keywords": ["python"]
        }
        </script>
    </body>
</html>
